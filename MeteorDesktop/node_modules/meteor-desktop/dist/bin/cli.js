#!/usr/bin/env node
'use strict';

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _assignIn = require('lodash/assignIn');

var _assignIn2 = _interopRequireDefault(_assignIn);

var _commander = require('commander');

var _commander2 = _interopRequireDefault(_commander);

var _shelljs = require('shelljs');

var _shelljs2 = _interopRequireDefault(_shelljs);

var _ = require('../..');

var _2 = _interopRequireDefault(_);

var _addScript = require('../scripts/utils/addScript');

var _addScript2 = _interopRequireDefault(_addScript);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

process.env.MD_LOG_LEVEL = 'ALL';
/* eslint-disable global-require */


var join = _path2.default.join;
var cmd = process.argv[2];

/* eslint-disable no-console */
var log = console.log;
var error = console.error;
var info = console.info;
var warn = console.warn;
/* eslint-enable no-console */

/**
 * Looks for .meteor directory.
 * @param {string} appPath - Meteor app path
 */
function isMeteorApp(appPath) {
    var meteorPath = join(appPath, '.meteor');
    try {
        return _fs2.default.statSync(meteorPath).isDirectory();
    } catch (e) {
        return false;
    }
}

/**
 * Just ensures a ddp url is set.
 *
 * @param {string|null} ddpUrl - the url that Meteor app connects to
 * @returns {string|null}
 */
function getDdpUrl() {
    var ddpUrl = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : null;

    if (!ddpUrl && _commander2.default.buildMeteor) {
        info('no ddp_url specified, setting default: http://127.0.0.1:3000');
        return 'http://127.0.0.1:3000';
    }
    return ddpUrl;
}

// --------------------------

_commander2.default.option('-b, --build-meteor', 'runs meteor to obtain the mobile build, kills it after').option('-t, --build-timeout <timeout_in_sec>', 'timeout value when waiting for ' + 'meteor to build, default 600sec').option('-p, --port <port>', 'port on which meteor is running, when with -b this will be passed to meteor when obtaining the build').option('--production', 'builds meteor app with the production switch, uglifies contents ' + 'of .desktop, packs app to app.asar').option('-a, --android', 'force adding android as a mobile platform instead of ios').option('-s, --scaffold', 'will scaffold .desktop if not present').option('--ia32', 'generate 32bit installer/package').option('--all-archs', 'generate 32bit and 64bit installers').option('--win', 'generate Windows installer').option('--linux', 'generate Linux installer').option('--mac', 'generate Mac installer');

_commander2.default.usage('[command] [options]').version(require('./../../package.json').version, '-V, --version').on('--help', function () {
    log('  [ddp_url] - pass a ddp url if you want to use different one than used in meteor\'s --mobile-server');
    log('              this will also work with -b');
    log('    ');
    log('  Examples:');
    log('');
    log('   ', ['# cd into meteor dir first', 'cd /your/meteor/app', 'meteor --mobile-server=127.0.0.1:3000', '', '# open new terminal, assuming you have done npm install --save-dev meteor-desktop', 'npm run desktop -- init', 'npm run desktop'].join('\n    '));
    log('\n');
});

function verifyArgsSyntax() {
    if (process.env.npm_config_argv) {
        var npmArgv = void 0;
        try {
            (function () {
                var args = ['-b', '--build-meteor', '-t', '--build-timeout', '-p', '--port', '--production', '-a', '--android', '-s', '--scaffold', '--ia32', '--win', '--linux', '--all-archs', '--win', '--mac'];
                npmArgv = JSON.parse(process.env.npm_config_argv);
                if (npmArgv.remain.length === 0 && npmArgv.original.length > 2) {
                    if (npmArgv.original.some(function (arg) {
                        return !!~args.indexOf(arg);
                    })) {
                        warn('WARNING: seems that you might used the wrong console syntax, no ` --' + ' ` delimiter was found, be sure you are invoking meteor-desktop with' + ' it when passing commands or options -> ' + '`npm run desktop -- command --option`\n');
                    }
                }
            })();
        } catch (e) {
            // Not sure if `npm_config_argv` is always present...
        }
    }
}

function meteorDesktopFactory(ddpUrl) {
    var production = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;

    info('METEOR-DESKTOP v' + require('./../../package.json').version + '\n');

    verifyArgsSyntax();

    var input = process.cwd();

    if (!isMeteorApp(input)) {
        error('not in a meteor app dir\n ' + input);
        process.exit();
    }

    if (!_commander2.default.output) {
        _commander2.default.output = input;
    }

    if (production && !_commander2.default.production) {
        info('package/build-installer implies setting --production, setting it for you');
    }

    if (!_commander2.default.buildMeteor) {
        _commander2.default.port = _commander2.default.port || 3000;
        info('REMINDER: your Meteor project should be running now on port ' + _commander2.default.port + '\n');
    }

    var options = {
        ddpUrl: ddpUrl,
        skipMobileBuild: _commander2.default.buildMeteor ? !_commander2.default.buildMeteor : true,
        production: _commander2.default.production || production
    };

    (0, _assignIn2.default)(options, _commander2.default);

    return (0, _2.default)(input, _commander2.default.output, options);
}

function run(ddpUrl) {
    meteorDesktopFactory(getDdpUrl(ddpUrl)).run();
}

function build(ddpUrl) {
    meteorDesktopFactory(getDdpUrl(ddpUrl)).build();
}

function init() {
    meteorDesktopFactory().init();
}

function justRun() {
    meteorDesktopFactory().justRun();
}

function runPackager(ddpUrl) {
    meteorDesktopFactory(getDdpUrl(ddpUrl), true).runPackager();
}

function buildInstaller(ddpUrl) {
    meteorDesktopFactory(getDdpUrl(ddpUrl), true).buildInstaller();
}

function initTestsSupport() {
    log('installing cross-env, ava, meteor-desktop-test-suite and spectron');
    log('running `meteor npm install --save-dev cross-env ava spectron meteor-desktop-test-suite`');

    var code = _shelljs2.default.exec('meteor npm install --save-dev cross-env ava spectron meteor-desktop-test-suite').code;

    if (code !== 0) {
        warn('could not add cross-env, ava and spectron to your `devDependencies`, please do it' + ' manually');
    }

    var test = 'cross-env NODE_ENV=test ava .desktop/**/*.test.js -s --verbose';
    var testWatch = 'cross-env NODE_ENV=test ava .desktop/**/*.test.js -s --verbose' + ' --watch --source .desktop';

    function fail() {
        error('\ncould not add entries to `scripts` in package.json');
        log('please try to add it manually\n');
        log('test-desktop: ' + test);
        log('test-desktop-watch: ' + testWatch);
    }

    var packageJsonPath = _path2.default.resolve(_path2.default.join(process.cwd(), 'package.json'));

    (0, _addScript2.default)('test-desktop', test, packageJsonPath, fail);
    (0, _addScript2.default)('test-desktop-watch', testWatch, packageJsonPath, fail);

    log('\nadded test-desktop and test-desktop-watch entries');
    log('run the test with `npm run test-desktop`');
}

_commander2.default.command('init').description('scaffolds .desktop dir in the meteor app').action(init);

_commander2.default.command('run [ddp_url]').description('(default) builds and runs desktop app').action(run);

_commander2.default.command('build [ddp_url]').description('builds your desktop app').action(build);

_commander2.default.command('build-installer [ddp_url]').description('creates the installer').action(buildInstaller);

_commander2.default.command('just-run').description('alias for running `electron .` in `.meteor/desktop-build`').action(justRun);

_commander2.default.command('package [ddp_url]').description('runs electron packager').action(runPackager);

_commander2.default.command('init-tests-support').description('prepares project for running functional tests of desktop app').action(initTestsSupport);

if (process.argv.length === 2 || !~'-h|--help|run|init|build|build-installer|just-run|init-tests-support|package'.indexOf(cmd)) {
    var argv = process.argv;
    if (process.argv.length === 2) {
        argv.push('run');
    } else {
        var command = argv.splice(0, 2);
        command = command.concat('run', argv);
        argv = command;
    }
    _commander2.default.parse(argv);
} else {
    _commander2.default.parse(process.argv);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9iaW4vY2xpLmpzIl0sIm5hbWVzIjpbInByb2Nlc3MiLCJlbnYiLCJNRF9MT0dfTEVWRUwiLCJqb2luIiwiY21kIiwiYXJndiIsImxvZyIsImNvbnNvbGUiLCJlcnJvciIsImluZm8iLCJ3YXJuIiwiaXNNZXRlb3JBcHAiLCJhcHBQYXRoIiwibWV0ZW9yUGF0aCIsInN0YXRTeW5jIiwiaXNEaXJlY3RvcnkiLCJlIiwiZ2V0RGRwVXJsIiwiZGRwVXJsIiwiYnVpbGRNZXRlb3IiLCJvcHRpb24iLCJ1c2FnZSIsInZlcnNpb24iLCJyZXF1aXJlIiwib24iLCJ2ZXJpZnlBcmdzU3ludGF4IiwibnBtX2NvbmZpZ19hcmd2IiwibnBtQXJndiIsImFyZ3MiLCJKU09OIiwicGFyc2UiLCJyZW1haW4iLCJsZW5ndGgiLCJvcmlnaW5hbCIsInNvbWUiLCJpbmRleE9mIiwiYXJnIiwibWV0ZW9yRGVza3RvcEZhY3RvcnkiLCJwcm9kdWN0aW9uIiwiaW5wdXQiLCJjd2QiLCJleGl0Iiwib3V0cHV0IiwicG9ydCIsIm9wdGlvbnMiLCJza2lwTW9iaWxlQnVpbGQiLCJydW4iLCJidWlsZCIsImluaXQiLCJqdXN0UnVuIiwicnVuUGFja2FnZXIiLCJidWlsZEluc3RhbGxlciIsImluaXRUZXN0c1N1cHBvcnQiLCJjb2RlIiwiZXhlYyIsInRlc3QiLCJ0ZXN0V2F0Y2giLCJmYWlsIiwicGFja2FnZUpzb25QYXRoIiwicmVzb2x2ZSIsImNvbW1hbmQiLCJkZXNjcmlwdGlvbiIsImFjdGlvbiIsInB1c2giLCJzcGxpY2UiLCJjb25jYXQiXSwibWFwcGluZ3MiOiI7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7O0FBQ0E7Ozs7OztBQUVBQSxRQUFRQyxHQUFSLENBQVlDLFlBQVosR0FBMkIsS0FBM0I7QUFWQTs7O0FBWUEsSUFBTUMsT0FBTyxlQUFLQSxJQUFsQjtBQUNBLElBQU1DLE1BQU1KLFFBQVFLLElBQVIsQ0FBYSxD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MkQsTUFBTCxDQUFZLENBQVosRUFBZSxDQUFmLENBQWQ7QUFDQUosa0JBQVVBLFFBQVFLLE1BQVIsQ0FBZSxLQUFmLEVBQXNCNUQsSUFBdEIsQ0FBVjtBQUNBQSxlQUFPdUQsT0FBUDtBQUNIO0FBQ0Qsd0JBQVE5QixLQUFSLENBQWN6QixJQUFkO0FBQ0gsQ0FYRCxNQVdPO0FBQ0gsd0JBQVF5QixLQUFSLENBQWM5QixRQUFRSyxJQUF0QjtBQUNIIiwiZmlsZSI6ImNsaS5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuLyogZXNsaW50LWRpc2FibGUgZ2xvYmFsLXJlcXVpcmUgKi9cbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBhc3NpZ25JbiBmcm9tICdsb2Rhc2gvYXNzaWduSW4nO1xuaW1wb3J0IHByb2dyYW0gZnJvbSAnY29tbWFuZGVyJztcbmltcG9ydCBzaGVsbCBmcm9tICdzaGVsbGpzJztcblxuaW1wb3J0IG1ldGVvckRlc2t0b3AgZnJvbSAnLi4vLi4nO1xuaW1wb3J0IGFkZFNjcmlwdCBmcm9tICcuLi9zY3JpcHRzL3V0aWxzL2FkZFNjcmlwdCc7XG5cbnByb2Nlc3MuZW52Lk1EX0xPR19MRVZFTCA9ICdBTEwnO1xuXG5jb25zdCBqb2luID0gcGF0aC5qb2luO1xuY29uc3QgY21kID0gcHJvY2Vzcy5hcmd2WzJdO1xuXG4vKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlICovXG5jb25zdCBsb2cgPSBjb25zb2xlLmxvZztcbmNvbnN0IGVycm9yID0gY29uc29sZS5lcnJvcjtcbmNvbnN0IGluZm8gPSBjb25zb2xlLmluZm87XG5jb25zdCB3YXJuID0gY29uc29sZS53YXJuO1xuLyogZXNsaW50LWVuYWJsZSBuby1jb25zb2xlICovXG5cbi8qKlxuICogTG9va3MgZm9yIC5tZXRlb3IgZGlyZWN0b3J5LlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcFBhdGggLSBNZXRlb3IgYXBwIHBhdGhcbiAqL1xuZnVuY3Rpb24gaXNNZXRlb3JBcHAoYXBwUGF0aCkge1xuICAgIGNvbnN0IG1ldGVvclBhdGggPSBqb2luKGFwcFBhdGgsICcubWV0ZW9yJyk7XG4gICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGZzLnN0YXRTeW5jKG1ldGVvclBhdGgpLmlzRGlyZWN0b3J5KCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufVxuXG4vKipcbiAqIEp1c3QgZW5zdXJlcyBhIGRkcCB1cmwgaXMgc2V0LlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfG51bGx9IGRkcFVybCAtIHRoZSB1cmwgdGhhdCBNZXRlb3IgYXBwIGNvbm5lY3RzIHRvXG4gKiBAcmV0dXJucyB7c3RyaW5nfG51bGx9XG4gKi9cbmZ1bmN0aW9uIGdldERkcFVybChkZHBVcmwgPSBudWxsKSB7XG4gICAgaWYgKCFkZHBVcmwgJiYgcHJvZ3JhbS5idWlsZE1ldGVvcikge1xuICAgICAgICBpbmZvKCdubyBkZHBfdXJsIHNwZWNpZmllZCwgc2V0dGluZyBkZWZhdWx0OiBodHRwOi8vMTI3LjAuMC4xOjMwMDAnKTtcbiAgICAgICAgcmV0dXJuICdodHRwOi8vMTI3LjAuMC4xOjMwMDAnO1xuICAgIH1cbiAgICByZXR1cm4gZGRwVXJsO1xufVxuXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5wcm9ncmFtXG4gICAgLm9wdGlvbignLWIsIC0tYnVpbGQtbWV0ZW9yJywgJ3J1bnMgbWV0ZW9yIHRvIG9idGFpbiB0aGUgbW9iaWxlIGJ1aWxkLCBraWxscyBpdCBhZnRlcicpXG4gICAgLm9wdGlvbignLXQsIC0tYnVpbGQtdGltZW91dCA8dGltZW91dF9pbl9zZWM+JywgJ3RpbWVvdXQgdmFsdWUgd2hlbiB3YWl0aW5nIGZvciAnICtcbiAgICAgICAgJ21ldGVvciB0byBidWlsZCwgZGVmYXVsdCA2MDBzZWMnKVxuICAgIC5vcHRpb24oJy1wLCAtLXBvcnQgPHBvcnQ+JywgJ3BvcnQgb24gd2hpY2ggbWV0ZW9yIGlzIHJ1bm5pbmcsIHdoZW4gd2l0aCAtYiB0aGlzIHdpbGwgYmUgcGFzc2VkIHRvIG1ldGVvciB3aGVuIG9idGFpbmluZyB0aGUgYnVpbGQnKVxuICAgIC5vcHRpb24oJy0tcHJvZHVjdGlvbicsICdidWlsZHMgbWV0ZW9yIGFwcCB3aXRoIHRoZSBwcm9kdWN0aW9uIHN3aXRjaCwgdWdsaWZpZXMgY29udGVudHMgJyArXG4gICAgICAgICdvZiAuZGVza3RvcCwgcGFja3MgYXBwIHRvIGFwcC5hc2FyJylcbiAgICAub3B0aW9uKCctYSwgLS1hbmRyb2lkJywgJ2ZvcmNlIGFkZGluZyBhbmRyb2lkIGFzIGEgbW9iaWxlIHBsYXRmb3JtIGluc3RlYWQgb2YgaW9zJylcbiAgICAub3B0aW9uKCctcywgLS1zY2FmZm9sZCcsICd3aWxsIHNjYWZmb2xkIC5kZXNrdG9wIGlmIG5vdCBwcmVzZW50JylcbiAgICAub3B0aW9uKCctLWlhMzInLCAnZ2VuZXJhdGUgMzJiaXQgaW5zdGFsbGVyL3BhY2thZ2UnKVxuICAgIC5vcHRpb24oJy0tYWxsLWFyY2hzJywgJ2dlbmVyYXRlIDMyYml0IGFuZCA2NGJpdCBpbnN0YWxsZXJzJylcbiAgICAub3B0aW9uKCctLXdpbicsICdnZW5lcmF0ZSBXaW5kb3dzIGluc3RhbGxlcicpXG4gICAgLm9wdGlvbignLS1saW51eCcsICdnZW5lcmF0ZSBMaW51eCBpbnN0YWxsZXInKVxuICAgIC5vcHRpb24oJy0tbWFjJywgJ2dlbmVyYXRlIE1hYyBpbnN0YWxsZXInKTtcblxucHJvZ3JhbVxuICAgIC51c2FnZSgnW2NvbW1hbmRdIFtvcHRpb25zXScpXG4gICAgLnZlcnNpb24ocmVxdWlyZSgnLi8uLi8uLi9wYWNrYWdlLmpzb24nKS52ZXJzaW9uLCAnLVYsIC0tdmVyc2lvbicpXG4gICAgLm9uKCctLWhlbHAnLCAoKSA9PiB7XG4gICAgICAgIGxvZygnICBbZGRwX3VybF0gLSBwYXNzIGEgZGRwIHVybCBpZiB5b3Ugd2FudCB0byB1c2UgZGlmZmVyZW50IG9uZSB0aGFuIHVzZWQgaW4gbWV0ZW9yXFwncyAtLW1vYmlsZS1zZXJ2ZXInKTtcbiAgICAgICAgbG9nKCcgICAgICAgICAgICAgIHRoaXMgd2lsbCBhbHNvIHdvcmsgd2l0aCAtYicpO1xuICAgICAgICBsb2coJyAgICAnKTtcbiAgICAgICAgbG9nKCcgIEV4YW1wbGVzOicpO1xuICAgICAgICBsb2coJycpO1xuICAgICAgICBsb2coJyAgICcsXG4gICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAgJyMgY2QgaW50byBtZXRlb3IgZGlyIGZpcnN0JyxcbiAgICAgICAgICAgICAgICAnY2QgL3lvdXIvbWV0ZW9yL2FwcCcsXG4gICAgICAgICAgICAgICAgJ21ldGVvciAtLW1vYmlsZS1zZXJ2ZXI9MTI3LjAuMC4xOjMwMDAnLFxuICAgICAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgICAgICcjIG9wZW4gbmV3IHRlcm1pbmFsLCBhc3N1bWluZyB5b3UgaGF2ZSBkb25lIG5wbSBpbnN0YWxsIC0tc2F2ZS1kZXYgbWV0ZW9yLWRlc2t0b3AnLFxuICAgICAgICAgICAgICAgICducG0gcnVuIGRlc2t0b3AgLS0gaW5pdCcsXG4gICAgICAgICAgICAgICAgJ25wbSBydW4gZGVza3RvcCdcbiAgICAgICAgICAgIF0uam9pbignXFxuICAgICcpXG4gICAgICAgICk7XG4gICAgICAgIGxvZygnXFxuJyk7XG4gICAgfSk7XG5cblxuZnVuY3Rpb24gdmVyaWZ5QXJnc1N5bnRheCgpIHtcbiAgICBpZiAocHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19hcmd2KSB7XG4gICAgICAgIGxldCBucG1Bcmd2O1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgYXJncyA9IFsnLWInLCAnLS1idWlsZC1tZXRlb3InLCAnLXQnLCAnLS1idWlsZC10aW1lb3V0JywgJy1wJywgJy0tcG9ydCcsXG4gICAgICAgICAgICAgICAgJy0tcHJvZHVjdGlvbicsICctYScsICctLWFuZHJvaWQnLCAnLXMnLCAnLS1zY2FmZm9sZCcsICctLWlhMzInLCAnLS13aW4nLFxuICAgICAgICAgICAgICAgICctLWxpbnV4JywgJy0tYWxsLWFyY2hzJywgJy0td2luJywgJy0tbWFjJ107XG4gICAgICAgICAgICBucG1Bcmd2ID0gSlNPTi5wYXJzZShwcm9jZXNzLmVudi5ucG1fY29uZmlnX2FyZ3YpO1xuICAgICAgICAgICAgaWYgKG5wbUFyZ3YucmVtYWluLmxlbmd0aCA9PT0gMCAmJiBucG1Bcmd2Lm9yaWdpbmFsLmxlbmd0aCA+IDIpIHtcbiAgICAgICAgICAgICAgICBpZiAobnBtQXJndi5vcmlnaW5hbC5zb21lKGFyZyA9PiAhIX5hcmdzLmluZGV4T2YoYXJnKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgd2FybignV0FSTklORzogc2VlbXMgdGhhdCB5b3UgbWlnaHQgdXNlZCB0aGUgd3JvbmcgY29uc29sZSBzeW50YXgsIG5vIGAgLS0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICcgYCBkZWxpbWl0ZXIgd2FzIGZvdW5kLCBiZSBzdXJlIHlvdSBhcmUgaW52b2tpbmcgbWV0ZW9yLWRlc2t0b3Agd2l0aCcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJyBpdCB3aGVuIHBhc3NpbmcgY29tbWFuZHMgb3Igb3B0aW9ucyAtPiAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICdgbnBtIHJ1biBkZXNrdG9wIC0tIGNvbW1hbmQgLS1vcHRpb25gXFxuJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAvLyBOb3Qgc3VyZSBpZiBgbnBtX2NvbmZpZ19hcmd2YCBpcyBhbHdheXMgcHJlc2VudC4uLlxuICAgICAgICB9XG4gICAgfVxufVxuXG5mdW5jdGlvbiBtZXRlb3JEZXNrdG9wRmFjdG9yeShkZHBVcmwsIHByb2R1Y3Rpb24gPSBmYWxzZSkge1xuICAgIGluZm8oYE1FVEVPUi1ERVNLVE9QIHYke3JlcXVpcmUoJy4vLi4vLi4vcGFja2FnZS5qc29uJykudmVyc2lvbn1cXG5gKTtcblxuICAgIHZlcmlmeUFyZ3NTeW50YXgoKTtcblxuICAgIGNvbnN0IGlucHV0ID0gcHJvY2Vzcy5jd2QoKTtcblxuICAgIGlmICghaXNNZXRlb3JBcHAoaW5wdXQpKSB7XG4gICAgICAgIGVycm9yKGBub3QgaW4gYSBtZXRlb3IgYXBwIGRpclxcbiAke2lucHV0fWApO1xuICAgICAgICBwcm9jZXNzLmV4aXQoKTtcbiAgICB9XG5cbiAgICBpZiAoIXByb2dyYW0ub3V0cHV0KSB7XG4gICAgICAgIHByb2dyYW0ub3V0cHV0ID0gaW5wdXQ7XG4gICAgfVxuXG4gICAgaWYgKHByb2R1Y3Rpb24gJiYgIXByb2dyYW0ucHJvZHVjdGlvbikge1xuICAgICAgICBpbmZvKCdwYWNrYWdlL2J1aWxkLWluc3RhbGxlciBpbXBsaWVzIHNldHRpbmcgLS1wcm9kdWN0aW9uLCBzZXR0aW5nIGl0IGZvciB5b3UnKTtcbiAgICB9XG5cbiAgICBpZiAoIXByb2dyYW0uYnVpbGRNZXRlb3IpIHtcbiAgICAgICAgcHJvZ3JhbS5wb3J0ID0gcHJvZ3JhbS5wb3J0IHx8IDMwMDA7XG4gICAgICAgIGluZm8oYFJFTUlOREVSOiB5b3VyIE1ldGVvciBwcm9qZWN0IHNob3VsZCBiZSBydW5uaW5nIG5vdyBvbiBwb3J0ICR7cHJvZ3JhbS5wb3J0fVxcbmApO1xuICAgIH1cblxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAgIGRkcFVybCxcbiAgICAgICAgc2tpcE1vYmlsZUJ1aWxkOiBwcm9ncmFtLmJ1aWxkTWV0ZW9yID8gIXByb2dyYW0uYnVpbGRNZXRlb3IgOiB0cnVlLFxuICAgICAgICBwcm9kdWN0aW9uOiBwcm9ncmFtLnByb2R1Y3Rpb24gfHwgcHJvZHVjdGlvblxuICAgIH07XG5cbiAgICBhc3NpZ25JbihvcHRpb25zLCBwcm9ncmFtKTtcblxuICAgIHJldHVybiBtZXRlb3JEZXNrdG9wKFxuICAgICAgICBpbnB1dCxcbiAgICAgICAgcHJvZ3JhbS5vdXRwdXQsXG4gICAgICAgIG9wdGlvbnNcbiAgICApO1xufVxuXG5mdW5jdGlvbiBydW4oZGRwVXJsKSB7XG4gICAgbWV0ZW9yRGVza3RvcEZhY3RvcnkoZ2V0RGRwVXJsKGRkcFVybCkpLnJ1bigpO1xufVxuXG5mdW5jdGlvbiBidWlsZChkZHBVcmwpIHtcbiAgICBtZXRlb3JEZXNrdG9wRmFjdG9yeShnZXREZHBVcmwoZGRwVXJsKSkuYnVpbGQoKTtcbn1cblxuZnVuY3Rpb24gaW5pdCgpIHtcbiAgICBtZXRlb3JEZXNrdG9wRmFjdG9yeSgpLmluaXQoKTtcbn1cblxuZnVuY3Rpb24ganVzdFJ1bigpIHtcbiAgICBtZXRlb3JEZXNrdG9wRmFjdG9yeSgpLmp1c3RSdW4oKTtcbn1cblxuZnVuY3Rpb24gcnVuUGFja2FnZXIoZGRwVXJsKSB7XG4gICAgbWV0ZW9yRGVza3RvcEZhY3RvcnkoZ2V0RGRwVXJsKGRkcFVybCksIHRydWUpLnJ1blBhY2thZ2VyKCk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkSW5zdGFsbGVyKGRkcFVybCkge1xuICAgIG1ldGVvckRlc2t0b3BGYWN0b3J5KGdldERkcFVybChkZHBVcmwpLCB0cnVlKS5idWlsZEluc3RhbGxlcigpO1xufVxuXG5mdW5jdGlvbiBpbml0VGVzdHNTdXBwb3J0KCkge1xuICAgIGxvZygnaW5zdGFsbGluZyBjcm9zcy1lbnYsIGF2YSwgbWV0ZW9yLWRlc2t0b3AtdGVzdC1zdWl0ZSBhbmQgc3BlY3Ryb24nKTtcbiAgICBsb2coJ3J1bm5pbmcgYG1ldGVvciBucG0gaW5zdGFsbCAtLXNhdmUtZGV2IGNyb3NzLWVudiBhdmEgc3BlY3Ryb24gbWV0ZW9yLWRlc2t0b3AtdGVzdC1zdWl0ZWAnKTtcblxuICAgIGNvbnN0IGNvZGUgPSBzaGVsbC5leGVjKCdtZXRlb3IgbnBtIGluc3RhbGwgLS1zYXZlLWRldiBjcm9zcy1lbnYgYXZhIHNwZWN0cm9uIG1ldGVvci1kZXNrdG9wLXRlc3Qtc3VpdGUnKS5jb2RlO1xuXG4gICAgaWYgKGNvZGUgIT09IDApIHtcbiAgICAgICAgd2FybignY291bGQgbm90IGFkZCBjcm9zcy1lbnYsIGF2YSBhbmQgc3BlY3Ryb24gdG8geW91ciBgZGV2RGVwZW5kZW5jaWVzYCwgcGxlYXNlIGRvIGl0JyArXG4gICAgICAgICAgICAnIG1hbnVhbGx5Jyk7XG4gICAgfVxuXG4gICAgY29uc3QgdGVzdCA9ICdjcm9zcy1lbnYgTk9ERV9FTlY9dGVzdCBhdmEgLmRlc2t0b3AvKiovKi50ZXN0LmpzIC1zIC0tdmVyYm9zZSc7XG4gICAgY29uc3QgdGVzdFdhdGNoID0gJ2Nyb3NzLWVudiBOT0RFX0VOVj10ZXN0IGF2YSAuZGVza3RvcC8qKi8qLnRlc3QuanMgLXMgLS12ZXJib3NlJyArXG4gICAgICAgICcgLS13YXRjaCAtLXNvdXJjZSAuZGVza3RvcCc7XG5cbiAgICBmdW5jdGlvbiBmYWlsKCkge1xuICAgICAgICBlcnJvcignXFxuY291bGQgbm90IGFkZCBlbnRyaWVzIHRvIGBzY3JpcHRzYCBpbiBwYWNrYWdlLmpzb24nKTtcbiAgICAgICAgbG9nKCdwbGVhc2UgdHJ5IHRvIGFkZCBpdCBtYW51YWxseVxcbicpO1xuICAgICAgICBsb2coYHRlc3QtZGVza3RvcDogJHt0ZXN0fWApO1xuICAgICAgICBsb2coYHRlc3QtZGVza3RvcC13YXRjaDogJHt0ZXN0V2F0Y2h9YCk7XG4gICAgfVxuXG4gICAgY29uc3QgcGFja2FnZUpzb25QYXRoID0gcGF0aC5yZXNvbHZlKFxuICAgICAgICBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgJ3BhY2thZ2UuanNvbicpKTtcblxuICAgIGFkZFNjcmlwdCgndGVzdC1kZXNrdG9wJywgdGVzdCwgcGFja2FnZUpzb25QYXRoLCBmYWlsKTtcbiAgICBhZGRTY3JpcHQoJ3Rlc3QtZGVza3RvcC13YXRjaCcsIHRlc3RXYXRjaCwgcGFja2FnZUpzb25QYXRoLCBmYWlsKTtcblxuICAgIGxvZygnXFxuYWRkZWQgdGVzdC1kZXNrdG9wIGFuZCB0ZXN0LWRlc2t0b3Atd2F0Y2ggZW50cmllcycpO1xuICAgIGxvZygncnVuIHRoZSB0ZXN0IHdpdGggYG5wbSBydW4gdGVzdC1kZXNrdG9wYCcpO1xufVxuXG5wcm9ncmFtXG4gICAgLmNvbW1hbmQoJ2luaXQnKVxuICAgIC5kZXNjcmlwdGlvbignc2NhZmZvbGRzIC5kZXNrdG9wIGRpciBpbiB0aGUgbWV0ZW9yIGFwcCcpXG4gICAgLmFjdGlvbihpbml0KTtcblxucHJvZ3JhbVxuICAgIC5jb21tYW5kKCdydW4gW2RkcF91cmxdJylcbiAgICAuZGVzY3JpcHRpb24oJyhkZWZhdWx0KSBidWlsZHMgYW5kIHJ1bnMgZGVza3RvcCBhcHAnKVxuICAgIC5hY3Rpb24ocnVuKTtcblxucHJvZ3JhbVxuICAgIC5jb21tYW5kKCdidWlsZCBbZGRwX3VybF0nKVxuICAgIC5kZXNjcmlwdGlvbignYnVpbGRzIHlvdXIgZGVza3RvcCBhcHAnKVxuICAgIC5hY3Rpb24oYnVpbGQpO1xuXG5wcm9ncmFtXG4gICAgLmNvbW1hbmQoJ2J1aWxkLWluc3RhbGxlciBbZGRwX3VybF0nKVxuICAgIC5kZXNjcmlwdGlvbignY3JlYXRlcyB0aGUgaW5zdGFsbGVyJylcbiAgICAuYWN0aW9uKGJ1aWxkSW5zdGFsbGVyKTtcblxucHJvZ3JhbVxuICAgIC5jb21tYW5kKCdqdXN0LXJ1bicpXG4gICAgLmRlc2NyaXB0aW9uKCdhbGlhcyBmb3IgcnVubmluZyBgZWxlY3Ryb24gLmAgaW4gYC5tZXRlb3IvZGVza3RvcC1idWlsZGAnKVxuICAgIC5hY3Rpb24oanVzdFJ1bik7XG5cbnByb2dyYW1cbiAgICAuY29tbWFuZCgncGFja2FnZSBbZGRwX3VybF0nKVxuICAgIC5kZXNjcmlwdGlvbigncnVucyBlbGVjdHJvbiBwYWNrYWdlcicpXG4gICAgLmFjdGlvbihydW5QYWNrYWdlcik7XG5cbnByb2dyYW1cbiAgICAuY29tbWFuZCgnaW5pdC10ZXN0cy1zdXBwb3J0JylcbiAgICAuZGVzY3JpcHRpb24oJ3ByZXBhcmVzIHByb2plY3QgZm9yIHJ1bm5pbmcgZnVuY3Rpb25hbCB0ZXN0cyBvZiBkZXNrdG9wIGFwcCcpXG4gICAgLmFjdGlvbihpbml0VGVzdHNTdXBwb3J0KTtcblxuaWYgKHByb2Nlc3MuYXJndi5sZW5ndGggPT09IDIgfHwgIX4oJy1ofC0taGVscHxydW58aW5pdHxidWlsZHxidWlsZC1pbnN0YWxsZXJ8anVzdC1ydW58aW5pdC10ZXN0cy1zdXBwb3J0fHBhY2thZ2UnLmluZGV4T2YoY21kKSlcbikge1xuICAgIGxldCBhcmd2ID0gcHJvY2Vzcy5hcmd2O1xuICAgIGlmIChwcm9jZXNzLmFyZ3YubGVuZ3RoID09PSAyKSB7XG4gICAgICAgIGFyZ3YucHVzaCgncnVuJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IGNvbW1hbmQgPSBhcmd2LnNwbGljZSgwLCAyKTtcbiAgICAgICAgY29tbWFuZCA9IGNvbW1hbmQuY29uY2F0KCdydW4nLCBhcmd2KTtcbiAgICAgICAgYXJndiA9IGNvbW1hbmQ7XG4gICAgfVxuICAgIHByb2dyYW0ucGFyc2UoYXJndik7XG59IGVsc2Uge1xuICAgIHByb2dyYW0ucGFyc2UocHJvY2Vzcy5hcmd2KTtcbn1cbiJdfQ==