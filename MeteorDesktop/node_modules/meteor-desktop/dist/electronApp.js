'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _typeof2 = require('babel-runtime/helpers/typeof');

var _typeof3 = _interopRequireDefault(_typeof2);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _sort = require('babel-runtime/core-js/array/sort');

var _sort2 = _interopRequireDefault(_sort);

var _concat = require('babel-runtime/core-js/array/concat');

var _concat2 = _interopRequireDefault(_concat);

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _asar = require('asar');

var _asar2 = _interopRequireDefault(_asar);

var _assignIn = require('lodash/assignIn');

var _assignIn2 = _interopRequireDefault(_assignIn);

var _babelCore = require('babel-core');

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var _del = require('del');

var _del2 = _interopRequireDefault(_del);

var _babelPresetEs = require('babel-preset-es2015');

var _babelPresetEs2 = _interopRequireDefault(_babelPresetEs);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _glob = require('glob');

var _glob2 = _interopRequireDefault(_glob);

var _babelPresetNode = require('babel-preset-node6');

var _babelPresetNode2 = _interopRequireDefault(_babelPresetNode);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _shelljs = require('shelljs');

var _shelljs2 = _interopRequireDefault(_shelljs);

var _crossSpawn = require('cross-spawn');

var _crossSpawn2 = _interopRequireDefault(_crossSpawn);

var _uglifyJs = require('uglify-js');

var _uglifyJs2 = _interopRequireDefault(_uglifyJs);

var _log = require('./log');

var _log2 = _interopRequireDefault(_log);

var _electronAppScaffold = require('./electronAppScaffold');

var _electronAppScaffold2 = _interopRequireDefault(_electronAppScaffold);

var _dependenciesManager = require('./dependenciesManager');

var _dependenciesManager2 = _interopRequireDefault(_dependenciesManager);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

_shelljs2.default.config.fatal = true;

/**
 * Represents the .desktop dir scaffold.
 * @class
 */

var ElectronApp = function () {

    /**
     * @param {MeteorDesktop} $ - context
     * @constructor
     */
    function ElectronApp($) {
        (0, _classCallCheck3.default)(this, ElectronApp);

        this.log = new _log2.default('electronApp');
        this.scaffold = new _electronAppScaffold2.default($);
        this.depsManager = new _dependenciesManager2.default($, this.scaffold.getDefaultPackageJson().dependencies);
        this.$ = $;
        this.meteorApp = this.$.meteorApp;
        this.packageJson = null;
        this.version = null;
        this.compatibilityVersion = null;
    }

    /**
     * Makes an app.asar from the skeleton app.
     * @property {Array} excludeFromDel - list of paths to exclude from deleting
     * @returns {Promise}
     */


    (0, _createClass3.default)(ElectronApp, [{
        key: 'packSkeletonToAsar',
        value: function packSkeletonToAsar() {
            var _this = this;

            var excludeFromDel = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];

            this.log.info('packing skeleton app and node_modules to asar archive');
            return new _promise2.default(function (resolve) {
                // We want to pack skeleton app and node_modules together, so we need to temporarily
                // move node_modules to app dir.
                _this.log.debug('moving node_modules to app dir');
                _shelljs2.default.mv(_this.$.env.paths.electronApp.nodeModules, _path2.default.join(_this.$.env.paths.electronApp.appRoot, 'node_modules'));
                _this.log.debug('packing');
                _asar2.default.createPackage(_this.$.env.paths.electronApp.appRoot, _this.$.env.paths.electronApp.appAsar, function () {
                    // Lets move the node_modules back.
                    _this.log.debug('moving node_modules back from app dir');
                    _shelljs2.default.mv(_path2.default.join(_this.$.env.paths.electronApp.appRoot, 'node_modules'), _this.$.env.paths.electronApp.nodeModules);
                    _this.log.debug('deleting source files');
                    var exclude = (0, _concat2.default)([_this.$.env.paths.electronApp.nodeModules, _this.$.env.paths.electronApp.appAsar, _this.$.env.paths.electronApp.packageJson], excludeFromDel);

                    _del2.default.sync((0, _concat2.default)(['' + _this.$.env.paths.electronApp.root + _path2.default.sep + '*'], exclude.map(function (pathToExclude) {
                        return '!' + pathToExclude;
                    })));
                    resolve();
                });
            });
        }

        /**
         * Calculates a md5 from all dependencies.
         */

    }, {
        key: 'calculateCompatibilityVersion',
        value: function calculateCompatibilityVersion() {
            var _this2 = this;

            this.log.verbose('calculating compatibility version');
            var md5 = _crypto2.default.createHash('md5');
            var dependencies = (0, _sort2.default)((0, _keys2.default)(this.packageJson.dependencies));
            dependencies = dependencies.map(function (dependency) {
                return dependency + ':' + _this2.packageJson.dependencies[dependency];
            });
            var mainCompatibilityVersion = this.$.getVersion().split('.');
            this.log.debug('meteor-desktop compatibility version is ', mainCompatibilityVersion[0] + '.' + mainCompatibilityVersion[1]);
            dependencies.push('meteor-desktop:' + mainCompatibilityVersion[0] + '.' + mainCompatibilityVersion[1]);

            var desktopCompatibilityVersion = this.$.desktop.getSettings().version.split('.')[0];
            this.log.debug('.desktop compatibility version is ', desktopCompatibilityVersion);
            dependencies.push('desktop-app:' + desktopCompatibilityVersion);

            if (process.env.METEOR_DESKTOP_DEBUG_DESKTOP_COMPATIBILITY_VERSION) {
                this.log.debug('compatibility version calculated from ' + (0, _stringify2.default)(dependencies));
            }

            md5.update((0, _stringify2.default)(dependencies));
            this.compatibilityVersion = md5.digest('hex');
        }

        /**
         * Runs all necessary tasks to build the desktopified app.
         */

    }, {
        key: 'build',
        value: function () {
            var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee() {
                var run = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;
                return _regenerator2.default.wrap(function _callee$(_context) {
                    while (1) {
                        switch (_context.prev = _context.next) {
                            case 0:
                                // TODO: refactor to a task runner
                                this.log.info('scaffolding');

                                if (!this.$.desktop.check()) {
                                    if (!this.$.env.options.scaffold) {
                                        this.log.error('seems that you do not have a .desktop dir in your project or it is' + ' corrupted. Run \'npm run desktop -- init\' to get a new one.');
                                        // Do not fail, so that npm will not print his error stuff to console.
                                        process.exit(0);
                                    } else {
                                        this.$.desktop.scaffold();
                                        this.$.meteorApp.updateGitIgnore();
                                    }
                                }

                                try {
                                    this.$.meteorApp.updateGitIgnore();
                                } catch (e) {
                                    this.log.warn('error occurred while adding ' + this.$.env.paths.electronApp.rootName + 'to .gitignore: ', e);
                                }

                                _context.prev = 3;
                                _context.next = 6;
                                return this.$.meteorApp.ensureDesktopHCPPackages();

                            case 6:
                                _context.next = 12;
                                break;

                            case 8:
                                _context.prev = 8;
                                _context.t0 = _context['catch'](3);

                                this.log.error('error while checking for required packages: ', _context.t0);
                                process.exit(1);

                            case 12:
                                _context.prev = 12;
                                _context.next = 15;
                                return this.scaffold.make();

                            case 15:
                                _context.next = 21;
                                break;

                            case 17:
                                _context.prev = 17;
                                _context.t1 = _context['catch'](12);

                                this.log.error('error while scaffolding: ', _context.t1);
                                process.exit(1);

                            case 21:

                                try {
                                    this.updatePackageJsonFields();
                                } catch (e) {
                                    this.log.error('error while updating package.json: ', e);
                                }

                                try {
                                    this.updateDependenciesList();
                                } catch (e) {
                                    this.log.error('error while merging dependencies list: ', e);
                                }

                                try {
                                    this.calculateCompatibilityVersion();
                                } catch (e) {
                                    this.log.error('error while calculating compatibility version: ', e);
                                    process.exit(1);
                                }

                                _context.prev = 24;
                                _context.next = 27;
                                return this.handleTemporaryNodeModules();

                            case 27:
                                _context.next = 33;
                                break;

                            case 29:
                                _context.prev = 29;
                                _context.t2 = _context['catch'](24);

                                this.log.error('error occurred while handling temporary node_modules: ', _context.t2);
                                process.exit(1);

                            case 33:
                                _context.prev = 33;
                                _context.next = 36;
                                return this.ensureDeps();

                            case 36:
                                _context.next = 42;
                                break;

                            case 38:
                                _context.prev = 38;
                                _context.t3 = _context['catch'](33);

                                this.log.error('error occurred while running npm: ', _context.t3);
                                process.exit(1);

                            case 42:
                                _context.prev = 42;
                                _context.next = 45;
                                return this.ensureMeteorDependencies();

                            case 45:
                                _context.next = 51;
                                break;

                            case 47:
                                _context.prev = 47;
                                _context.t4 = _context['catch'](42);

                                this.log.error('error occurred while running npm: ', _context.t4);
                                process.exit(1);

                            case 51:
                                _context.prev = 51;
                                _context.next = 54;
                                return this.rebuildDeps();

                            case 54:
                                _context.next = 60;
                                break;

                            case 56:
                                _context.prev = 56;
                                _context.t5 = _context['catch'](51);

                                this.log.error('error occurred while rebuilding native node modules: ', _context.t5);
                                process.exit(1);

                            case 60:
                                if (!this.$.env.isProductionBuild()) {
                                    _context.next = 70;
                                    break;
                                }

                                _context.prev = 61;
                                _context.next = 64;
                                return this.packSkeletonToAsar();

                            case 64:
                                _context.next = 70;
                                break;

                            case 66:
                                _context.prev = 66;
                                _context.t6 = _context['catch'](61);

                                this.log.error('error while packing skeleton to asar: ', _context.t6);
                                process.exit(1);

                            case 70:

                                // TODO: find a way to avoid copying .desktop to a temp location
                                try {
                                    this.copyDesktopToDesktopTemp();
                                } catch (e) {
                                    this.log.error('error while copying .desktop to a temporary location: ', e);
                                    process.exit(1);
                                }

                                try {
                                    this.updateSettingsJsonFields();
                                } catch (e) {
                                    this.log.error('error while updating settings.json: ', e);
                                    process.exit(1);
                                }

                                _context.prev = 72;
                                _context.next = 75;
                                return this.excludeFilesFromArchive();

                            case 75:
                                _context.next = 81;
                                break;

                            case 77:
                                _context.prev = 77;
                                _context.t7 = _context['catch'](72);

                                this.log.error('error while excluding files from packing to asar: ', _context.t7);
                                process.exit(1);

                            case 81:

                                try {
                                    this.transpileAndMinify();
                                } catch (e) {
                                    this.log.error('error while transpiling or minifying: ', e);
                                }

                                _context.prev = 82;
                                _context.next = 85;
                                return this.packDesktopToAsar();

                            case 85:
                                _context.next = 91;
                                break;

                            case 87:
                                _context.prev = 87;
                                _context.t8 = _context['catch'](82);

                                this.log.error('error occurred while packing .desktop to asar: ', _context.t8);
                                process.exit(1);

                            case 91:
                                _context.prev = 91;
                                _context.next = 94;
                                return this.getMeteorClientBuild();

                            case 94:
                                _context.next = 99;
                                break;

                            case 96:
                                _context.prev = 96;
                                _context.t9 = _context['catch'](91);

                                this.log.error('error occurred during getting meteor mobile build: ', _context.t9);

                            case 99:

                                if (run) {
                                    this.log.info('running');
                                    this.$.electron.run();
                                } else {
                                    this.log.info('built');
                                }

                            case 100:
                            case 'end':
                                return _context.stop();
                        }
                    }
                }, _callee, this, [[3, 8], [12, 17], [24, 29], [33, 38], [42, 47], [51, 56], [61, 66], [72, 77], [82, 87], [91, 96]]);
            }));

            function build() {
                return _ref.apply(this, arguments);
            }

            return build;
        }()
    }, {
        key: 'ensureMeteorDependencies',
        value: function () {
            var _ref2 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2() {
                var _this3 = this;

                var packages, packagesWithVersion, plugins;
                return _regenerator2.default.wrap(function _callee2$(_context2) {
                    while (1) {
                        switch (_context2.prev = _context2.next) {
                            case 0:
                                packages = [];
                                packagesWithVersion = [];
                                plugins = 'plugins [';


                                (0, _keys2.default)(this.$.desktop.getDependencies().plugins).forEach(function (plugin) {
                                    // Read package.json of the plugin.
                                    var packageJson = JSON.parse(_fs2.default.readFileSync(_path2.default.join(_this3.$.env.paths.electronApp.nodeModules, plugin, 'package.json'), 'utf8'));

                                    if ('meteorDependencies' in packageJson && (0, _typeof3.default)(packageJson.meteorDependencies) === 'object') {
                                        plugins += plugin + ', ';
                                        packages.unshift.apply(packages, (0, _toConsumableArray3.default)((0, _keys2.default)(packageJson.meteorDependencies)));
                                        packagesWithVersion.unshift.apply(packagesWithVersion, (0, _toConsumableArray3.default)(packages.map(function (packageName) {
                                            if (packageJson.meteorDependencies[packageName] === '@version') {
                                                return packageName + '@' + packageJson.version;
                                            }
                                            return packageName + '@' + packageJson.meteorDependencies[packageName];
                                        })));
                                    }
                                });

                                if (!(packages.length > 0)) {
                                    _context2.next = 14;
                                    break;
                                }

                                plugins = plugins.substr(0, plugins.length - 2) + ']';
                                _context2.prev = 6;
                                _context2.next = 9;
                                return this.$.meteorApp.ensurePackages(packages, packagesWithVersion, plugins);

                            case 9:
                                _context2.next = 14;
                                break;

                            case 11:
                                _context2.prev = 11;
                                _context2.t0 = _context2['catch'](6);
                                throw new Error(_context2.t0);

                            case 14:
                            case 'end':
                                return _context2.stop();
                        }
                    }
                }, _callee2, this, [[6, 11]]);
            }));

            function ensureMeteorDependencies() {
                return _ref2.apply(this, arguments);
            }

            return ensureMeteorDependencies;
        }()

        /**
         * Builds meteor app.
         */

    }, {
        key: 'getMeteorClientBuild',
        value: function () {
            var _ref3 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee3() {
                return _regenerator2.default.wrap(function _callee3$(_context3) {
                    while (1) {
                        switch (_context3.prev = _context3.next) {
                            case 0:
                                _context3.next = 2;
                                return this.$.meteorApp.build();

                            case 2:
                            case 'end':
                                return _context3.stop();
                        }
                    }
                }, _callee3, this);
            }));

            function getMeteorClientBuild() {
                return _ref3.apply(this, arguments);
            }

            return getMeteorClientBuild;
        }()
    }, {
        key: 'handleTemporaryNodeModules',
        value: function () {
            var _ref4 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee4() {
                return _regenerator2.default.wrap(function _callee4$(_context4) {
                    while (1) {
                        switch (_context4.prev = _context4.next) {
                            case 0:
                                if (!this.$.utils.exists(this.$.env.paths.electronApp.tmpNodeModules)) {
                                    _context4.next = 15;
                                    break;
                                }

                                if (this.$.utils.exists(this.$.env.paths.electronApp.nodeModules)) {
                                    _context4.next = 6;
                                    break;
                                }

                                this.log.debug('moving temp node_modules back');
                                _shelljs2.default.mv(this.$.env.paths.electronApp.tmpNodeModules, this.$.env.paths.electronApp.nodeModules);
                                _context4.next = 15;
                                break;

                            case 6:
                                // If there is a node_modules folder, we should clear the temporary one.
                                this.log.debug('clearing temp node_modules because new one is already created');
                                _context4.prev = 7;
                                _context4.next = 10;
                                return this.$.utils.rmWithRetries('-rf', this.$.env.paths.electronApp.tmpNodeModules);

                            case 10:
                                _context4.next = 15;
                                break;

                            case 12:
                                _context4.prev = 12;
                                _context4.t0 = _context4['catch'](7);
                                throw new Error(_context4.t0);

                            case 15:
                            case 'end':
                                return _context4.stop();
                        }
                    }
                }, _callee4, this, [[7, 12]]);
            }));

            function handleTemporaryNodeModules() {
                return _ref4.apply(this, arguments);
            }

            return handleTemporaryNodeModules;
        }()

        /**
         * Wrapper for spawning npm.
         * @param {Array}  commands - commands for spawn
         * @param {string} stdio
         * @return {Promise}
         */

    }, {
        key: 'runNpm',
        value: function runNpm(commands) {
            var _this4 = this;

            var stdio = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'ignore';

            return new _promise2.default(function (resolve, reject) {
                // TODO: find a way to run npm without depending on it cause it's a huge dependency.
                var npm = _path2.default.join(_this4.$.env.paths.meteorApp.root, 'node_modules', '.bin', 'npm');
                _this4.log.verbose('executing npm ' + commands.join(' '));

                (0, _crossSpawn2.default)(npm, commands, {
                    cwd: _this4.$.env.paths.electronApp.root,
                    stdio: stdio
                }).on('exit', function (code) {
                    return code === 0 ? resolve() : reject('npm exit code was ' + code);
                });
            });
        }

        /**
         * Runs npm link for every package specified in settings.json->linkPackages.
         */

    }, {
        key: 'linkNpmPackages',
        value: function () {
            var _ref5 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee5() {
                var _this5 = this;

                var settings, promises;
                return _regenerator2.default.wrap(function _callee5$(_context5) {
                    while (1) {
                        switch (_context5.prev = _context5.next) {
                            case 0:
                                settings = this.$.desktop.getSettings();
                                promises = [];

                                if ('linkPackages' in this.$.desktop.getSettings()) {
                                    if (Array.isArray(settings.linkPackages)) {
                                        settings.linkPackages.forEach(function (packageName) {
                                            return promises.push(_this5.runNpm(['link', packageName]));
                                        });
                                    }
                                }
                                _context5.next = 5;
                                return _promise2.default.all(promises);

                            case 5:
                            case 'end':
                                return _context5.stop();
                        }
                    }
                }, _callee5, this);
            }));

            function linkNpmPackages() {
                return _ref5.apply(this, arguments);
            }

            return linkNpmPackages;
        }()

        /**
         * Runs npm in the electron app to get the dependencies installed.
         * @returns {Promise}
         */

    }, {
        key: 'ensureDeps',
        value: function () {
            var _ref6 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee6() {
                return _regenerator2.default.wrap(function _callee6$(_context6) {
                    while (1) {
                        switch (_context6.prev = _context6.next) {
                            case 0:
                                _context6.next = 2;
                                return this.linkNpmPackages();

                            case 2:

                                this.log.info('installing dependencies');

                                if (!this.$.utils.exists(this.$.env.paths.electronApp.nodeModules)) {
                                    _context6.next = 13;
                                    break;
                                }

                                this.log.debug('running npm prune to wipe unneeded dependencies');
                                _context6.prev = 5;
                                _context6.next = 8;
                                return this.runNpm(['prune']);

                            case 8:
                                _context6.next = 13;
                                break;

                            case 10:
                                _context6.prev = 10;
                                _context6.t0 = _context6['catch'](5);
                                throw new Error(_context6.t0);

                            case 13:
                                _context6.prev = 13;
                                _context6.next = 16;
                                return this.runNpm(['install'], this.$.env.stdio);

                            case 16:
                                _context6.next = 21;
                                break;

                            case 18:
                                _context6.prev = 18;
                                _context6.t1 = _context6['catch'](13);
                                throw new Error(_context6.t1);

                            case 21:
                            case 'end':
                                return _context6.stop();
                        }
                    }
                }, _callee6, this, [[5, 10], [13, 18]]);
            }));

            function ensureDeps() {
                return _ref6.apply(this, arguments);
            }

            return ensureDeps;
        }()

        /**
         * Warns if plugins version are outdated in compare to the newest scaffold.
         * @param {Object} pluginsVersions - current plugins versions from settings.json
         */

    }, {
        key: 'checkPluginsVersion',
        value: function checkPluginsVersion(pluginsVersions) {
            var _this6 = this;

            var settingsJson = JSON.parse(_fs2.default.readFileSync(_path2.default.join(this.$.env.paths.scaffold, 'settings.json')));
            var scaffoldPluginsVersion = this.$.desktop.getDependencies(settingsJson, false).plugins;
            (0, _keys2.default)(pluginsVersions).forEach(function (pluginName) {
                if (scaffoldPluginsVersion[pluginName] !== pluginsVersions[pluginName]) {
                    _this6.log.warn('you are using outdated version ' + pluginsVersions[pluginName] + ' of ' + (pluginName + ', the suggested version to use is ') + ('' + scaffoldPluginsVersion[pluginName]));
                }
            });
        }

        /**
         * Merges core dependency list with the dependencies from .desktop.
         */

    }, {
        key: 'updateDependenciesList',
        value: function updateDependenciesList() {
            var _this7 = this;

            this.log.info('updating list of package.json\'s dependencies');
            var desktopDependencies = this.$.desktop.getDependencies();

            this.checkPluginsVersion(desktopDependencies.plugins);

            this.log.debug('merging settings.json[dependencies]');
            this.depsManager.mergeDependencies('settings.json[dependencies]', desktopDependencies.fromSettings);
            this.log.debug('merging settings.json[plugins]');
            this.depsManager.mergeDependencies('settings.json[plugins]', desktopDependencies.plugins);

            this.log.debug('merging dependencies from modules');
            (0, _keys2.default)(desktopDependencies.modules).forEach(function (module) {
                return _this7.depsManager.mergeDependencies('module[' + module + ']', desktopDependencies.modules[module]);
            });

            this.packageJson.dependencies = this.depsManager.getDependencies();

            this.log.debug('writing updated package.json');
            _fs2.default.writeFileSync(this.$.env.paths.electronApp.packageJson, (0, _stringify2.default)(this.packageJson, null, 2));
        }

        /**
         * Rebuild binary dependencies against Electron's node headers.
         * @returns {Promise}
         */

    }, {
        key: 'rebuildDeps',
        value: function rebuildDeps() {
            if (!this.$.desktop.getSettings().rebuildNativeNodeModules) {
                this.log.warn('native modules rebuild is turned off, be sure to turn it on if you' + ' added any native node ' + 'modules');
                return _promise2.default.resolve();
            }

            this.log.info('issuing native modules rebuild from electron-builder');

            return this.$.electronBuilder.installOrRebuild('x64');
        }

        /**
         * Update package.json fields accordingly to what is set in settings.json.
         *
         * packageJson.name = settings.projectName
         * packageJson.version = settings.version
         * packageJson.* = settings.packageJsonFields
         */

    }, {
        key: 'updatePackageJsonFields',
        value: function updatePackageJsonFields() {
            this.log.verbose('updating package.json fields');
            var settings = this.$.desktop.getSettings();
            /** @type {desktopSettings} */
            var packageJson = this.scaffold.getDefaultPackageJson();

            packageJson.version = settings.version;
            if ('packageJsonFields' in settings) {
                (0, _assignIn2.default)(packageJson, settings.packageJsonFields);
            }
            (0, _assignIn2.default)(packageJson, { name: settings.projectName });

            this.log.debug('writing updated package.json');
            _fs2.default.writeFileSync(this.$.env.paths.electronApp.packageJson, (0, _stringify2.default)(packageJson, null, 4));
            this.packageJson = packageJson;
        }

        /**
         * Updates settings.json with env (prod/dev) information and versions.
         */

    }, {
        key: 'updateSettingsJsonFields',
        value: function updateSettingsJsonFields() {
            this.log.debug('updating settings.json fields');
            var settings = this.$.desktop.getSettings();

            // Save versions.
            settings.desktopVersion = this.$.desktop.getHashVersion();
            settings.compatibilityVersion = this.compatibilityVersion;

            // Pass information about build type to the settings.json.
            settings.env = this.$.env.isProductionBuild() ? 'prod' : 'dev';

            settings.meteorDesktopVersion = this.$.getVersion();

            _fs2.default.writeFileSync(this.$.env.paths.desktopTmp.settings, (0, _stringify2.default)(settings, null, 4));
        }

        /**
         * Copies files from prepared .desktop to desktop.asar in electron app.
         */

    }, {
        key: 'packDesktopToAsar',
        value: function packDesktopToAsar() {
            var _this8 = this;

            this.log.info('packing .desktop to asar');
            return new _promise2.default(function (resolve, reject) {
                _asar2.default.createPackage(_this8.$.env.paths.desktopTmp.root, _this8.$.env.paths.electronApp.desktopAsar, function () {
                    _this8.log.verbose('clearing temporary .desktop');
                    _this8.$.utils.rmWithRetries('-rf', _this8.$.env.paths.desktopTmp.root).then(function () {
                        resolve();
                    }).catch(function (e) {
                        reject(e);
                    });
                });
            });
        }

        /**
         * Makes a temporary copy of .desktop.
         */

    }, {
        key: 'copyDesktopToDesktopTemp',
        value: function copyDesktopToDesktopTemp() {
            this.log.verbose('copying .desktop to temporary location');
            _shelljs2.default.cp('-rf', this.$.env.paths.desktop.root, this.$.env.paths.desktopTmp.root);
            // Remove test files.
            _del2.default.sync([_path2.default.join(this.$.env.paths.desktopTmp.root, '**', '*.test.js')]);
        }

        /**
         * Runs babel and uglify over .desktop if requested.
         */

    }, {
        key: 'transpileAndMinify',
        value: function transpileAndMinify() {
            this.log.info('transpiling and uglifying');

            var settings = this.$.desktop.getSettings();
            var options = 'uglifyOptions' in settings ? settings.uglifyOptions : {};
            options.fromString = true;
            var uglifyingEnabled = 'uglify' in settings && !!settings.uglify;

            // Unfortunately `reify` will not work when we require a .js file from an asar archive.
            // So here we will transpile .desktop to have the ES6 modules working.

            // Uglify does not handle ES6 yet, so we will have to transpile to ES5 for now.
            var preset = uglifyingEnabled && settings.env === 'prod' ? _babelPresetEs2.default : _babelPresetNode2.default;

            _glob2.default.sync(this.$.env.paths.desktopTmp.root + '/**/*.js').forEach(function (file) {
                var _transformFileSync = (0, _babelCore.transformFileSync)(file, {
                    presets: [preset]
                }),
                    code = _transformFileSync.code;

                if (settings.env === 'prod' && uglifyingEnabled) {
                    code = _uglifyJs2.default.minify(code, options).code;
                }
                _fs2.default.writeFileSync(file, code);
            });
        }

        /**
         * Moves all the files that should not be packed into asar into a safe location which is the
         * 'extracted' dir in the electron app.
         */

    }, {
        key: 'excludeFilesFromArchive',
        value: function () {
            var _ref7 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee7() {
                var _this9 = this;

                var configs;
                return _regenerator2.default.wrap(function _callee7$(_context7) {
                    while (1) {
                        switch (_context7.prev = _context7.next) {
                            case 0:
                                this.log.info('excluding files from packing');

                                // Ensure empty `extracted` dir

                                _context7.prev = 1;
                                _context7.next = 4;
                                return this.$.utils.rmWithRetries('-rf', this.$.env.paths.electronApp.extracted);

                            case 4:
                                _context7.next = 9;
                                break;

                            case 6:
                                _context7.prev = 6;
                                _context7.t0 = _context7['catch'](1);
                                throw new Error(_context7.t0);

                            case 9:

                                _shelljs2.default.mkdir(this.$.env.paths.electronApp.extracted);

                                configs = this.$.desktop.gatherModuleConfigs();

                                // Move files that should not be asar'ed.

                                configs.forEach(function (config) {
                                    var moduleConfig = config;
                                    if ('extract' in moduleConfig) {
                                        if (!Array.isArray(moduleConfig.extract)) {
                                            moduleConfig.extract = [moduleConfig.extract];
                                        }
                                        moduleConfig.extract.forEach(function (file) {
                                            _this9.log.debug('excluding ' + file + ' from ' + config.name);
                                            var filePath = _path2.default.join(_this9.$.env.paths.desktopTmp.modules, moduleConfig.dirName, file);
                                            var destinationPath = _path2.default.join(_this9.$.env.paths.electronApp.extracted, moduleConfig.dirName);

                                            if (!_this9.$.utils.exists(destinationPath)) {
                                                _shelljs2.default.mkdir(destinationPath);
                                            }
                                            _shelljs2.default.mv(filePath, destinationPath);
                                        });
                                    }
                                });

                            case 12:
                            case 'end':
                                return _context7.stop();
                        }
                    }
                }, _callee7, this, [[1, 6]]);
            }));

            function excludeFilesFromArchive() {
                return _ref7.apply(this, arguments);
            }

            return excludeFilesFromArchive;
        }()
    }]);
    return ElectronApp;
}();

exports.default = ElectronApp;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9lbGVjdHJvbkFwcC5qcyJdLCJuYW1lcyI6WyJjb25maWciLCJmYXRhbCIsIkVsZWN0cm9uQXBwIiwiJCIsImxvZyIsInNjYWZmb2xkIiwiZGVwc01hbmFnZXIiLCJnZXREZWZhdWx0UGFja2FnZUpzb24iLCJkZXBlbmRlbmNpZXMiLCJtZXRlb3JBcHAiLCJwYWNrYWdlSnNvbiIsInZlcnNpb24iLCJjb21wYXRpYmlsaXR5VmVyc2lvbiIsImV4Y2x1ZGVGcm9tRGVsIiwiaW5mbyIsInJlc29sdmUiLCJkZWJ1ZyIsIm12IiwiZW52IiwicGF0aHMiLCJlbGVjdHJvbkFwcCIsIm5vZGVNb2R1bGVzIiwiam9pbiIsImFwcFJvb3QiLCJjcmVhdGVQYWNrYWdlIiwiYXBwQXNhciIsImV4Y2x1ZGUiLCJzeW5jIiwicm9vdCIsInNlcCIsIm1hcCIsInBhdGhUb0V4Y2x1ZGUiLCJ2ZXJib3NlIiwibWQ1IiwiY3JlYXRlSGFzaCIsImRlcGVuZGVuY3kiLCJtYWluQ29tcGF0aWJpbGl0eVZlcnNpb24iLCJnZXRWZXJzaW9uIiwic3BsaXQiLCJwdXNoIiwiZGVza3RvcENvbXBhdGliaWxpdHlWZXJzaW9uIiwiZGVza3RvcCIsImdldFNldHRpbmdzIiwicHJvY2VzcyIsIk1FVEVPUl9ERVNLVE9QX0RFQlVHX0RFU0tUT1BfQ09NUEFUSUJJTElUWV9WRVJTSU9OIiwidXBkYXRlIiwiZGlnZXN0IiwicnVuIiwiY2hlY2siLCJvcHRpb25zIiwiZXJyb3IiLCJleGl0IiwidXBkYXRlR2l0SWdub3JlIiwiZSIsIndhcm4iLCJyb290TmFtZSIsImVuc3VyZURlc2t0b3BIQ1BQYWNrYWdlcyIsIm1ha2UiLCJ1cGRhdGVQYWNrYWdlSnNvbkZpZWxkcyIsInVwZGF0ZURlcGVuZGVuY2llc0xpc3QiLCJjYWxjdWxhdGVDb21wYXRpYmlsaXR5VmVyc2lvbiIsImhhbmRsZVRlbXBvcmFyeU5vZGVNb2R1bGVzIiwiZW5zdXJlRGVwcyIsImVuc3VyZU1ldGVvckRlcGVuZGVuY2llcyIsInJlYnVpbGREZXBzIiwiaXNQcm9kdWN0aW9uQnVpbGQiLCJwYWNrU2tlbGV0b25Ub0FzYXIiLCJjb3B5RGVza3RvcFRvRGVza3RvcFRlbXAiLCJ1cGRhdGVTZXR0aW5nc0pzb25GaWVsZHMiLCJleGNsdWRlRmlsZXNGcm9tQXJjaGl2ZSIsInRyYW5zcGlsZUFuZE1pbmlmeSIsInBhY2tEZXNrdG9wVG9Bc2FyIiwiZ2V0TWV0ZW9yQ2xpZW50QnVpbGQiLCJlbGVjdHJvbiIsInBhY2thZ2VzIiwicGFja2FnZXNXaXRoVmVyc2lvbiIsInBsdWdpbnMiLCJnZXREZXBlbmRlbmNpZXMiLCJmb3JFYWNoIiwicGx1Z2luIiwiSlNPTiIsInBhcnNlIiwicmVhZEZpbGVTeW5jIiwibWV0ZW9yRGVwZW5kZW5jaWVzIiwidW5zaGlmdCIsInBhY2thZ2VOYW1lIiwibGVuZ3RoIiwic3Vic3RyIiwiZW5zdXJlUGFja2FnZXMiLCJFcnJvciIsImJ1aWxkIiwidXRpbHMiLCJleGlzdHMiLCJ0bXBOb2RlTW9kdWxlcyIsInJtV2l0aFJldHJpZXMiLCJjb21tYW5kcyIsInN0ZGlvIiwicmVqZWN0IiwibnBtIiwiY3dkIiwib24iLCJjb2RlIiwic2V0dGluZ3MiLCJwcm9taXNlcyIsIkFycmF5IiwiaXNBcnJheSIsImxpbmtQYWNrYWdlcyIsInJ1bk5wbSIsImFsbCIsImxpbmtOcG1QYWNrYWdlcyIsInBsdWdpbnNWZXJzaW9ucyIsInNldHRpbmdzSnNvbiIsInNjYWZmb2xkUGx1Z2luc1ZlcnNpb24iLCJwbHVnaW5OYW1lIiwiZGVza3RvcERlcGVuZGVuY2llcyIsImNoZWNrUGx1Z2luc1ZlcnNpb24iLCJtZXJnZURlcGVuZGVuY2llcyIsImZyb21TZXR0aW5ncyIsIm1vZHVsZXMiLCJtb2R1bGUiLCJ3cml0ZUZpbGVTeW5jIiwicmVidWlsZE5hdGl2ZU5vZGVNb2R1bGVzIiwiZWxlY3Ryb25CdWlsZGVyIiwiaW5zdGFsbE9yUmVidWlsZCIsInBhY2thZ2VKc29uRmllbGRzIiwibmFtZSIsInByb2plY3ROYW1lIiwiZGVza3RvcFZlcnNpb24iLCJnZXRIYXNoVmVyc2lvbiIsIm1ldGVvckRlc2t0b3BWZXJzaW9uIiwiZGVza3RvcFRtcCIsImRlc2t0b3BBc2FyIiwidGhlbiIsImNhdGNoIiwiY3AiLCJ1Z2xpZnlPcHRpb25zIiwiZnJvbVN0cmluZyIsInVnbGlmeWluZ0VuYWJsZWQiLCJ1Z2xpZnkiLCJwcmVzZXQiLCJmaWxlIiwicHJlc2V0cyIsIm1pbmlmeSIsImV4dHJhY3RlZCIsIm1rZGlyIiwiY29uZmlncyIsImdhdGhlck1vZHVsZUNvbmZpZ3MiLCJtb2R1bGVDb25maWciLCJleHRyYWN0IiwiZmlsZVBhdGgiLCJkaXJOYW1lIiwiZGVzdGluYXRpb25QYXRoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUdBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUEsa0JBQU1BLE1BQU4sQ0FBYUMsS0FBYixHQUFxQixJQUFyQjs7QUFFQTs7Ozs7SUFJcUJDLFc7O0FBRWpCOzs7O0FBSUEseUJBQVlDLENBQVosRUFBZTtBQUFBOztBQUNYLGFBQUtDLEdBQUwsR0FBVyxrQkFBUSxhQUFSLENBQVg7QUFDQSxhQUFLQyxRQUFMLEdBQWdCLGtDQUF3QkYsQ0FBeEIsQ0FBaEI7QUFDQSxhQUFLRyxXQUFMLEdBQW1CLGtDQUNmSCxDQURlLEVBRWYsS0FBS0UsUUFBTCxDQUFjRSxxQkFBZCxHQUFzQ0MsWUFGdkIsQ0FBbkI7QUFJQSxhQUFLTCxDQUFMLEdBQVNBLENBQVQ7QUFDQSxhQUFLTSxTQUFMLEdBQWlCLEtBQUtOLENBQUwsQ0FBT00sU0FBeEI7QUFDQSxhQUFLQyxXQUFMLEdBQW1CLElBQW5CO0FBQ0EsYUFBS0MsT0FBTCxHQUFlLElBQWY7QUFDQSxhQUFLQyxvQkFBTCxHQUE0QixJQUE1QjtBQUNIOztBQUVEOzs7Ozs7Ozs7NkNBS3dDO0FBQUE7O0FBQUEsZ0JBQXJCQyxjQUFxQix1RUFBSixFQUFJOztBQUNwQyxpQkFBS1QsR0FBTCxDQUFTVSxJQUFULENBQWMsdURBQWQ7QUFDQSxtQkFBTyxzQkFBWSxVQUFDQyxPQUFELEVBQWE7QUFDNUI7QUFDQTtBQUNBLHNCQUFLWCxHQUFMLENBQVNZLEtBQVQsQ0FBZSxnQ0FBZjtBQUNBLGtDQUFNQyxFQUFOLENBQ0ksTUFBS2QsQ0FBTCxDQUFPZSxHQUFQLENBQVdDLEtBQVgsQ0FBaUJDLFdBQWpCLENBQTZCQyxXQURqQyxFQUVJLGVBQUtDLElBQUwsQ0FBVSxNQUFLbkIsQ0FBTCxDQUFPZSxHQUFQLENBQVdDLEtBQVgsQ0FBaUJDLFdBQWpCLENBQTZCRyxPQUF2QyxFQUFnRCxjQUFoRCxDQUZKO0FBSUEsc0JBQUtuQixHQUFMLENBQVNZLEtBQVQsQ0FBZSxTQUFmO0FBQ0EsK0JBQUtRLGFBQUwsQ0FDSSxNQUFLckIsQ0FBTCxDQUFPZSxHQUFQLENBQVdDLEtBQVgsQ0FBaUJDLFdBQWpCLENBQTZCRyxPQURqQyxFQUVJLE1BQUtwQixDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQkMsV0FBakIsQ0FBNkJLLE9BRmpDLEVBR0ksWUFBTTtBQUNGO0FBQ0EsMEJBQUtyQixHQUFMLENBQVNZLEtBQVQsQ0FBZSx1Q0FBZjtBQUNBLHNDQUFNQyxFQUFOLENBQ0ksZUFBS0ssSUFBTCxDQUFVLE1BQUtuQixDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQkMsV0FBakIsQ0FBNkJHLE9BQXZDLEVBQWdELGNBQWhELENBREosRUFFSSxNQUFLcEIsQ0FBTCxDQUFPZSxHQUFQLENBQVdDLEtBQVgsQ0FBaUJDLFdBQWpCLENBQTZCQyxXQUZqQztBQUlBLDBCQUFLakIsR0FBTCxDQUFTWSxLQUFULENBQWUsdUJBQWY7QUFDQSx3QkFBTVUsVUFBVSxzQkFBYSxDQUN6QixNQUFLdkIsQ0FBTCxDQUFPZSxHQUFQLENBQVdDLEtBQVgsQ0FBaUJDLFdBQWpCLENBQTZCQyxXQURKLEVBRXpCLE1BQUtsQixDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQkMsV0FBakIsQ0FBNkJLLE9BRkosRUFHekIsTUFBS3RCLENBQUwsQ0FBT2UsR0FBUCxDQUFXQyxLQUFYLENBQWlCQyxXQUFqQixDQUE2QlYsV0FISixDQUFiLEVBSWJHLGNBSmEsQ0FBaEI7O0FBTUEsa0NBQUljLElBQUosQ0FDSSxzQkFDSSxNQUFJLE1BQUt4QixDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQkMsV0FBakIsQ0FBNkJRLElBQWpDLEdBQXdDLGVBQUtDLEdBQTdDLE9BREosRUFFSUgsUUFBUUksR0FBUixDQUFZO0FBQUEscUNBQXFCQyxhQUFyQjtBQUFBLHFCQUFaLENBRkosQ0FESjtBQU1BaEI7QUFDSCxpQkF4Qkw7QUEwQkgsYUFuQ00sQ0FBUDtBQW9DSDs7QUFFRDs7Ozs7O3dEQUdnQztBQUFBOztBQUM1QixpQkFBS1gsR0FBTCxDQUFTNEIsT0FBVCxDQUFpQixtQ0FBakI7QUFDQSxnQkFBTUMsTUFBTSxpQkFBT0MsVUFBUCxDQUFrQixLQUFsQixDQUFaO0FBQ0EsZ0JBQUkxQixlQUFlLG9CQUFXLG9CQUFZLEtBQUtFLFdBQUwsQ0FBaUJGLFlBQTdCLENBQVgsQ0FBbkI7QUFDQUEsMkJBQWVBLGFBQWFzQixHQUFiLENBQWlCO0FBQUEsdUJBQ3pCSyxVQUR5QixTQUNYLE9BQUt6QixXQUFMLENBQWlCRixZQUFqQixDQUE4QjJCLFVBQTlCLENBRFc7QUFBQSxhQUFqQixDQUFmO0FBR0EsZ0JBQU1DLDJCQUEyQixLQUFLakMsQ0FBTCxDQUFPa0MsVUFBUCxHQUFvQkMsS0FBcEIsQ0FBMEIsR0FBMUIsQ0FBakM7QUFDQSxpQkFBS2xDLEdBQUwsQ0FBU1ksS0FBVCxDQUFlLDBDQUFmLEVBQ09vQix5QkFBeUIsQ0FBekIsQ0FEUCxTQUNzQ0EseUJBQXlCLENBQXpCLENBRHRDO0FBRUE1Qix5QkFBYStCLElBQWIscUJBQ3NCSCx5QkFBeUIsQ0FBekIsQ0FEdEIsU0FDcURBLHlCQUF5QixDQUF6QixDQURyRDs7QUFHQSxnQkFBTUksOEJBQThCLEtBQUtyQyxDQUFMLENBQU9zQyxPQUFQLENBQWVDLFdBQWYsR0FBNkIvQixPQUE3QixDQUFxQzJCLEtBQXJDLENBQTJDLEdBQTNDLEVBQWdELENBQWhELENBQXBDO0FBQ0EsaUJBQUtsQyxHQUFMLENBQVNZLEtBQVQsQ0FBZSxvQ0FBZixFQUFxRHdCLDJCQUFyRDtBQUNBaEMseUJBQWErQixJQUFiLGtCQUNtQkMsMkJBRG5COztBQUdBLGdCQUFJRyxRQUFRekIsR0FBUixDQUFZMEIsa0RBQWhCLEVBQW9FO0FBQ2hFLHFCQUFLeEMsR0FBTCxDQUFTWSxLQUFULDRDQUF3RCx5QkFBZVIsWUFBZixDQUF4RDtBQUNIOztBQUVEeUIsZ0JBQUlZLE1BQUosQ0FBVyx5QkFBZXJDLFlBQWYsQ0FBWDtBQUNBLGlCQUFLSSxvQkFBTCxHQUE0QnFCLElBQUlhLE1BQUosQ0FBVyxLQUFYLENBQTVCO0FBQ0g7O0FBRUQ7Ozs7Ozs7O29CQUdZQyxHLHVFQUFNLEs7Ozs7O0FBQ2Q7QUFDQSxxQ0FBSzNDLEdBQUwsQ0FBU1UsSUFBVCxDQUFjLGFBQWQ7O0FBRUEsb0NBQUksQ0FBQyxLQUFLWCxDQUFMLENBQU9zQyxPQUFQLENBQWVPLEtBQWYsRUFBTCxFQUE2QjtBQUN6Qix3Q0FBSSxDQUFDLEtBQUs3QyxDQUFMLENBQU9lLEdBQVAsQ0FBVytCLE9BQVgsQ0FBbUI1QyxRQUF4QixFQUFrQztBQUM5Qiw2Q0FBS0QsR0FBTCxDQUFTOEMsS0FBVCxDQUFlLHVFQUNYLCtEQURKO0FBRUE7QUFDQVAsZ0RBQVFRLElBQVIsQ0FBYSxDQUFiO0FBQ0gscUNBTEQsTUFLTztBQUNILDZDQUFLaEQsQ0FBTCxDQUFPc0MsT0FBUCxDQUFlcEMsUUFBZjtBQUNBLDZDQUFLRixDQUFMLENBQU9NLFNBQVAsQ0FBaUIyQyxlQUFqQjtBQUNIO0FBQ0o7O0FBRUQsb0NBQUk7QUFDQSx5Q0FBS2pELENBQUwsQ0FBT00sU0FBUCxDQUFpQjJDLGVBQWpCO0FBQ0gsaUNBRkQsQ0FFRSxPQUFPQyxDQUFQLEVBQVU7QUFDUix5Q0FBS2pELEdBQUwsQ0FBU2tELElBQVQsQ0FBYyxpQ0FBK0IsS0FBS25ELENBQUwsQ0FBT2UsR0FBUCxDQUFXQyxLQUFYLENBQWlCQyxXQUFqQixDQUE2Qm1DLFFBQTVELEdBQ1YsaUJBREosRUFDdUJGLENBRHZCO0FBRUg7Ozs7dUNBR1MsS0FBS2xELENBQUwsQ0FBT00sU0FBUCxDQUFpQitDLHdCQUFqQixFOzs7Ozs7Ozs7O0FBRU4scUNBQUtwRCxHQUFMLENBQVM4QyxLQUFULENBQWUsOENBQWY7QUFDQVAsd0NBQVFRLElBQVIsQ0FBYSxDQUFiOzs7Ozt1Q0FJTSxLQUFLOUMsUUFBTCxDQUFjb0QsSUFBZCxFOzs7Ozs7Ozs7O0FBRU4scUNBQUtyRCxHQUFMLENBQVM4QyxLQUFULENBQWUsMkJBQWY7QUFDQVAsd0NBQVFRLElBQVIsQ0FBYSxDQUFiOzs7O0FBR0osb0NBQUk7QUFDQSx5Q0FBS08sdUJBQUw7QUFDSCxpQ0FGRCxDQUVFLE9BQU9MLENBQVAsRUFBVTtBQUNSLHlDQUFLakQsR0FBTCxDQUFTOEMsS0FBVCxDQUFlLHFDQUFmLEVBQXNERyxDQUF0RDtBQUNIOztBQUVELG9DQUFJO0FBQ0EseUNBQUtNLHNCQUFMO0FBQ0gsaUNBRkQsQ0FFRSxPQUFPTixDQUFQLEVBQVU7QUFDUix5Q0FBS2pELEdBQUwsQ0FBUzhDLEtBQVQsQ0FBZSx5Q0FBZixFQUEwREcsQ0FBMUQ7QUFDSDs7QUFFRCxvQ0FBSTtBQUNBLHlDQUFLTyw2QkFBTDtBQUNILGlDQUZELENBRUUsT0FBT1AsQ0FBUCxFQUFVO0FBQ1IseUNBQUtqRCxHQUFMLENBQVM4QyxLQUFULENBQWUsaURBQWYsRUFBa0VHLENBQWxFO0FBQ0FWLDRDQUFRUSxJQUFSLENBQWEsQ0FBYjtBQUNIOzs7O3VDQUtTLEtBQUtVLDBCQUFMLEU7Ozs7Ozs7Ozs7QUFFTixxQ0FBS3pELEdBQUwsQ0FBUzhDLEtBQVQsQ0FBZSx3REFBZjtBQUNBUCx3Q0FBUVEsSUFBUixDQUFhLENBQWI7Ozs7O3VDQUlNLEtBQUtXLFVBQUwsRTs7Ozs7Ozs7OztBQUVOLHFDQUFLMUQsR0FBTCxDQUFTOEMsS0FBVCxDQUFlLG9DQUFmO0FBQ0FQLHdDQUFRUSxJQUFSLENBQWEsQ0FBYjs7Ozs7dUNBSU0sS0FBS1ksd0JBQUwsRTs7Ozs7Ozs7OztBQUVOLHFDQUFLM0QsR0FBTCxDQUFTOEMsS0FBVCxDQUFlLG9DQUFmO0FBQ0FQLHdDQUFRUSxJQUFSLENBQWEsQ0FBYjs7Ozs7dUNBSU0sS0FBS2EsV0FBTCxFOzs7Ozs7Ozs7O0FBRU4scUNBQUs1RCxHQUFMLENBQVM4QyxLQUFULENBQWUsdURBQWY7QUFDQVAsd0NBQVFRLElBQVIsQ0FBYSxDQUFiOzs7cUNBR0EsS0FBS2hELENBQUwsQ0FBT2UsR0FBUCxDQUFXK0MsaUJBQVgsRTs7Ozs7Ozt1Q0FFVSxLQUFLQyxrQkFBTCxFOzs7Ozs7Ozs7O0FBRU4scUNBQUs5RCxHQUFMLENBQVM4QyxLQUFULENBQWUsd0NBQWY7QUFDQVAsd0NBQVFRLElBQVIsQ0FBYSxDQUFiOzs7O0FBSVI7QUFDQSxvQ0FBSTtBQUNBLHlDQUFLZ0Isd0JBQUw7QUFDSCxpQ0FGRCxDQUVFLE9BQU9kLENBQVAsRUFBVTtBQUNSLHlDQUFLakQsR0FBTCxDQUFTOEMsS0FBVCxDQUFlLHdEQUFmLEVBQXlFRyxDQUF6RTtBQUNBViw0Q0FBUVEsSUFBUixDQUFhLENBQWI7QUFDSDs7QUFFRCxvQ0FBSTtBQUNBLHlDQUFLaUIsd0JBQUw7QUFDSCxpQ0FGRCxDQUVFLE9BQU9mLENBQVAsRUFBVTtBQUNSLHlDQUFLakQsR0FBTCxDQUFTOEMsS0FBVCxDQUFlLHNDQUFmLEVBQXVERyxDQUF2RDtBQUNBViw0Q0FBUVEsSUFBUixDQUFhLENBQWI7QUFDSDs7Ozt1Q0FHUyxLQUFLa0IsdUJBQUwsRTs7Ozs7Ozs7OztBQUVOLHFDQUFLakUsR0FBTCxDQUFTOEMsS0FBVCxDQUFlLG9EQUFmO0FBQ0FQLHdDQUFRUSxJQUFSLENBQWEsQ0FBYjs7OztBQUdKLG9DQUFJO0FBQ0EseUNBQUttQixrQkFBTDtBQUNILGlDQUZELENBRUUsT0FBT2pCLENBQVAsRUFBVTtBQUNSLHlDQUFLakQsR0FBTCxDQUFTOEMsS0FBVCxDQUFlLHdDQUFmLEVBQXlERyxDQUF6RDtBQUNIOzs7O3VDQUdTLEtBQUtrQixpQkFBTCxFOzs7Ozs7Ozs7O0FBRU4scUNBQUtuRSxHQUFMLENBQVM4QyxLQUFULENBQWUsaURBQWY7QUFDQVAsd0NBQVFRLElBQVIsQ0FBYSxDQUFiOzs7Ozt1Q0FJTSxLQUFLcUIsb0JBQUwsRTs7Ozs7Ozs7OztBQUVOLHFDQUFLcEUsR0FBTCxDQUFTOEMsS0FBVCxDQUFlLHFEQUFmOzs7O0FBR0osb0NBQUlILEdBQUosRUFBUztBQUNMLHlDQUFLM0MsR0FBTCxDQUFTVSxJQUFULENBQWMsU0FBZDtBQUNBLHlDQUFLWCxDQUFMLENBQU9zRSxRQUFQLENBQWdCMUIsR0FBaEI7QUFDSCxpQ0FIRCxNQUdPO0FBQ0gseUNBQUszQyxHQUFMLENBQVNVLElBQVQsQ0FBYyxPQUFkO0FBQ0g7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUlLNEQsd0MsR0FBVyxFO0FBQ1hDLG1ELEdBQXNCLEU7QUFDeEJDLHVDLEdBQVUsVzs7O0FBRWQsb0RBQVksS0FBS3pFLENBQUwsQ0FBT3NDLE9BQVAsQ0FBZW9DLGVBQWYsR0FBaUNELE9BQTdDLEVBQXNERSxPQUF0RCxDQUE4RCxVQUFDQyxNQUFELEVBQVk7QUFDdEU7QUFDQSx3Q0FBTXJFLGNBQ0ZzRSxLQUFLQyxLQUFMLENBQ0ksYUFBR0MsWUFBSCxDQUNJLGVBQUs1RCxJQUFMLENBQ0ksT0FBS25CLENBQUwsQ0FBT2UsR0FBUCxDQUFXQyxLQUFYLENBQWlCQyxXQUFqQixDQUE2QkMsV0FEakMsRUFDOEMwRCxNQUQ5QyxFQUNzRCxjQUR0RCxDQURKLEVBR0ksTUFISixDQURKLENBREo7O0FBU0Esd0NBQUksd0JBQXdCckUsV0FBeEIsSUFBdUMsc0JBQU9BLFlBQVl5RSxrQkFBbkIsTUFBMEMsUUFBckYsRUFBK0Y7QUFDM0ZQLG1EQUFjRyxNQUFkO0FBQ0FMLGlEQUFTVSxPQUFULGtEQUFvQixvQkFBWTFFLFlBQVl5RSxrQkFBeEIsQ0FBcEI7QUFDQVIsNERBQW9CUyxPQUFwQiw2REFBK0JWLFNBQVM1QyxHQUFULENBQWEsVUFBQ3VELFdBQUQsRUFBaUI7QUFDekQsZ0RBQUkzRSxZQUFZeUUsa0JBQVosQ0FBK0JFLFdBQS9CLE1BQWdELFVBQXBELEVBQWdFO0FBQzVELHVEQUFVQSxXQUFWLFNBQXlCM0UsWUFBWUMsT0FBckM7QUFDSDtBQUNELG1EQUFVMEUsV0FBVixTQUF5QjNFLFlBQVl5RSxrQkFBWixDQUErQkUsV0FBL0IsQ0FBekI7QUFDSCx5Q0FMOEIsQ0FBL0I7QUFNSDtBQUNKLGlDQXJCRDs7c0NBdUJJWCxTQUFTWSxNQUFULEdBQWtCLEM7Ozs7O0FBQ2xCViwwQ0FBYUEsUUFBUVcsTUFBUixDQUFlLENBQWYsRUFBa0JYLFFBQVFVLE1BQVIsR0FBaUIsQ0FBbkMsQ0FBYjs7O3VDQUVVLEtBQUtuRixDQUFMLENBQU9NLFNBQVAsQ0FBaUIrRSxjQUFqQixDQUFnQ2QsUUFBaEMsRUFBMENDLG1CQUExQyxFQUErREMsT0FBL0QsQzs7Ozs7Ozs7O3NDQUVBLElBQUlhLEtBQUosYzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFLbEI7Ozs7Ozs7Ozs7Ozs7dUNBSVUsS0FBS3RGLENBQUwsQ0FBT00sU0FBUCxDQUFpQmlGLEtBQWpCLEU7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztxQ0FJRixLQUFLdkYsQ0FBTCxDQUFPd0YsS0FBUCxDQUFhQyxNQUFiLENBQW9CLEtBQUt6RixDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQkMsV0FBakIsQ0FBNkJ5RSxjQUFqRCxDOzs7OztvQ0FDSyxLQUFLMUYsQ0FBTCxDQUFPd0YsS0FBUCxDQUFhQyxNQUFiLENBQW9CLEtBQUt6RixDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQkMsV0FBakIsQ0FBNkJDLFdBQWpELEM7Ozs7O0FBQ0QscUNBQUtqQixHQUFMLENBQVNZLEtBQVQsQ0FBZSwrQkFBZjtBQUNBLGtEQUFNQyxFQUFOLENBQ0ksS0FBS2QsQ0FBTCxDQUFPZSxHQUFQLENBQVdDLEtBQVgsQ0FBaUJDLFdBQWpCLENBQTZCeUUsY0FEakMsRUFFSSxLQUFLMUYsQ0FBTCxDQUFPZSxHQUFQLENBQVdDLEtBQVgsQ0FBaUJDLFdBQWpCLENBQTZCQyxXQUZqQzs7Ozs7QUFLQTtBQUNBLHFDQUFLakIsR0FBTCxDQUFTWSxLQUFULENBQWUsK0RBQWY7Ozt1Q0FFVSxLQUFLYixDQUFMLENBQU93RixLQUFQLENBQWFHLGFBQWIsQ0FDRixLQURFLEVBQ0ssS0FBSzNGLENBQUwsQ0FBT2UsR0FBUCxDQUFXQyxLQUFYLENBQWlCQyxXQUFqQixDQUE2QnlFLGNBRGxDLEM7Ozs7Ozs7OztzQ0FHQSxJQUFJSixLQUFKLGM7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBTXRCOzs7Ozs7Ozs7K0JBTU9NLFEsRUFBNEI7QUFBQTs7QUFBQSxnQkFBbEJDLEtBQWtCLHVFQUFWLFFBQVU7O0FBQy9CLG1CQUFPLHNCQUFZLFVBQUNqRixPQUFELEVBQVVrRixNQUFWLEVBQXFCO0FBQ3BDO0FBQ0Esb0JBQU1DLE1BQU0sZUFBSzVFLElBQUwsQ0FDUixPQUFLbkIsQ0FBTCxDQUFPZSxHQUFQLENBQVdDLEtBQVgsQ0FBaUJWLFNBQWpCLENBQTJCbUIsSUFEbkIsRUFDeUIsY0FEekIsRUFDeUMsTUFEekMsRUFDaUQsS0FEakQsQ0FBWjtBQUVBLHVCQUFLeEIsR0FBTCxDQUFTNEIsT0FBVCxvQkFBa0MrRCxTQUFTekUsSUFBVCxDQUFjLEdBQWQsQ0FBbEM7O0FBRUEsMENBQU00RSxHQUFOLEVBQVdILFFBQVgsRUFBcUI7QUFDakJJLHlCQUFLLE9BQUtoRyxDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQkMsV0FBakIsQ0FBNkJRLElBRGpCO0FBRWpCb0U7QUFGaUIsaUJBQXJCLEVBR0dJLEVBSEgsQ0FHTSxNQUhOLEVBR2M7QUFBQSwyQkFDTEMsU0FBUyxDQUFWLEdBQWV0RixTQUFmLEdBQTJCa0YsOEJBQTRCSSxJQUE1QixDQURyQjtBQUFBLGlCQUhkO0FBT0gsYUFiTSxDQUFQO0FBY0g7O0FBR0Q7Ozs7Ozs7Ozs7Ozs7OztBQUlVQyx3QyxHQUFXLEtBQUtuRyxDQUFMLENBQU9zQyxPQUFQLENBQWVDLFdBQWYsRTtBQUNYNkQsd0MsR0FBVyxFOztBQUNqQixvQ0FBSSxrQkFBa0IsS0FBS3BHLENBQUwsQ0FBT3NDLE9BQVAsQ0FBZUMsV0FBZixFQUF0QixFQUFvRDtBQUNoRCx3Q0FBSThELE1BQU1DLE9BQU4sQ0FBY0gsU0FBU0ksWUFBdkIsQ0FBSixFQUEwQztBQUN0Q0osaURBQVNJLFlBQVQsQ0FBc0I1QixPQUF0QixDQUE4QjtBQUFBLG1EQUMxQnlCLFNBQVNoRSxJQUFULENBQWMsT0FBS29FLE1BQUwsQ0FBWSxDQUFDLE1BQUQsRUFBU3RCLFdBQVQsQ0FBWixDQUFkLENBRDBCO0FBQUEseUNBQTlCO0FBR0g7QUFDSjs7dUNBQ0ssa0JBQVF1QixHQUFSLENBQVlMLFFBQVosQzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFHVjs7Ozs7Ozs7Ozs7Ozs7dUNBS1UsS0FBS00sZUFBTCxFOzs7O0FBRU4scUNBQUt6RyxHQUFMLENBQVNVLElBQVQsQ0FBYyx5QkFBZDs7cUNBQ0ksS0FBS1gsQ0FBTCxDQUFPd0YsS0FBUCxDQUFhQyxNQUFiLENBQW9CLEtBQUt6RixDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQkMsV0FBakIsQ0FBNkJDLFdBQWpELEM7Ozs7O0FBQ0EscUNBQUtqQixHQUFMLENBQVNZLEtBQVQsQ0FBZSxpREFBZjs7O3VDQUVVLEtBQUsyRixNQUFMLENBQVksQ0FBQyxPQUFELENBQVosQzs7Ozs7Ozs7O3NDQUVBLElBQUlsQixLQUFKLGM7Ozs7O3VDQUlKLEtBQUtrQixNQUFMLENBQVksQ0FBQyxTQUFELENBQVosRUFBeUIsS0FBS3hHLENBQUwsQ0FBT2UsR0FBUCxDQUFXOEUsS0FBcEMsQzs7Ozs7Ozs7O3NDQUVBLElBQUlQLEtBQUosYzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFJZDs7Ozs7Ozs0Q0FJb0JxQixlLEVBQWlCO0FBQUE7O0FBQ2pDLGdCQUFNQyxlQUFlL0IsS0FBS0MsS0FBTCxDQUNqQixhQUFHQyxZQUFILENBQWdCLGVBQUs1RCxJQUFMLENBQVUsS0FBS25CLENBQUwsQ0FBT2UsR0FBUCxDQUFXQyxLQUFYLENBQWlCZCxRQUEzQixFQUFxQyxlQUFyQyxDQUFoQixDQURpQixDQUFyQjtBQUdBLGdCQUFNMkcseUJBQXlCLEtBQUs3RyxDQUFMLENBQU9zQyxPQUFQLENBQWVvQyxlQUFmLENBQStCa0MsWUFBL0IsRUFBNkMsS0FBN0MsRUFBb0RuQyxPQUFuRjtBQUNBLGdDQUFZa0MsZUFBWixFQUE2QmhDLE9BQTdCLENBQXFDLFVBQUNtQyxVQUFELEVBQWdCO0FBQ2pELG9CQUFJRCx1QkFBdUJDLFVBQXZCLE1BQXVDSCxnQkFBZ0JHLFVBQWhCLENBQTNDLEVBQXdFO0FBQ3BFLDJCQUFLN0csR0FBTCxDQUFTa0QsSUFBVCxDQUFjLG9DQUFrQ3dELGdCQUFnQkcsVUFBaEIsQ0FBbEMsYUFDUEEsVUFETyxpREFFUEQsdUJBQXVCQyxVQUF2QixDQUZPLENBQWQ7QUFHSDtBQUNKLGFBTkQ7QUFPSDs7QUFFRDs7Ozs7O2lEQUd5QjtBQUFBOztBQUNyQixpQkFBSzdHLEdBQUwsQ0FBU1UsSUFBVCxDQUFjLCtDQUFkO0FBQ0EsZ0JBQU1vRyxzQkFBc0IsS0FBSy9HLENBQUwsQ0FBT3NDLE9BQVAsQ0FBZW9DLGVBQWYsRUFBNUI7O0FBRUEsaUJBQUtzQyxtQkFBTCxDQUF5QkQsb0JBQW9CdEMsT0FBN0M7O0FBRUEsaUJBQUt4RSxHQUFMLENBQVNZLEtBQVQsQ0FBZSxxQ0FBZjtBQUNBLGlCQUFLVixXQUFMLENBQWlCOEcsaUJBQWpCLENBQ0ksNkJBREosRUFFSUYsb0JBQW9CRyxZQUZ4QjtBQUlBLGlCQUFLakgsR0FBTCxDQUFTWSxLQUFULENBQWUsZ0NBQWY7QUFDQSxpQkFBS1YsV0FBTCxDQUFpQjhHLGlCQUFqQixDQUNJLHdCQURKLEVBRUlGLG9CQUFvQnRDLE9BRnhCOztBQUtBLGlCQUFLeEUsR0FBTCxDQUFTWSxLQUFULENBQWUsbUNBQWY7QUFDQSxnQ0FBWWtHLG9CQUFvQkksT0FBaEMsRUFBeUN4QyxPQUF6QyxDQUFpRDtBQUFBLHVCQUM3QyxPQUFLeEUsV0FBTCxDQUFpQjhHLGlCQUFqQixhQUNjRyxNQURkLFFBRUlMLG9CQUFvQkksT0FBcEIsQ0FBNEJDLE1BQTVCLENBRkosQ0FENkM7QUFBQSxhQUFqRDs7QUFPQSxpQkFBSzdHLFdBQUwsQ0FBaUJGLFlBQWpCLEdBQWdDLEtBQUtGLFdBQUwsQ0FBaUJ1RSxlQUFqQixFQUFoQzs7QUFFQSxpQkFBS3pFLEdBQUwsQ0FBU1ksS0FBVCxDQUFlLDhCQUFmO0FBQ0EseUJBQUd3RyxhQUFILENBQ0ksS0FBS3JILENBQUwsQ0FBT2UsR0FBUCxDQUFXQyxLQUFYLENBQWlCQyxXQUFqQixDQUE2QlYsV0FEakMsRUFDOEMseUJBQWUsS0FBS0EsV0FBcEIsRUFBaUMsSUFBakMsRUFBdUMsQ0FBdkMsQ0FEOUM7QUFHSDs7QUFFRDs7Ozs7OztzQ0FJYztBQUNWLGdCQUFJLENBQUMsS0FBS1AsQ0FBTCxDQUFPc0MsT0FBUCxDQUFlQyxXQUFmLEdBQTZCK0Usd0JBQWxDLEVBQTREO0FBQ3hELHFCQUFLckgsR0FBTCxDQUFTa0QsSUFBVCxDQUFjLHVFQUNWLHlCQURVLEdBRVYsU0FGSjtBQUdBLHVCQUFPLGtCQUFRdkMsT0FBUixFQUFQO0FBQ0g7O0FBRUQsaUJBQUtYLEdBQUwsQ0FBU1UsSUFBVCxDQUFjLHNEQUFkOztBQUVBLG1CQUFPLEtBQUtYLENBQUwsQ0FBT3VILGVBQVAsQ0FBdUJDLGdCQUF2QixDQUF3QyxLQUF4QyxDQUFQO0FBQ0g7O0FBRUQ7Ozs7Ozs7Ozs7a0RBTzBCO0FBQ3RCLGlCQUFLdkgsR0FBTCxDQUFTNEIsT0FBVCxDQUFpQiw4QkFBakI7QUFDQSxnQkFBTXNFLFdBQVcsS0FBS25HLENBQUwsQ0FBT3NDLE9BQVAsQ0FBZUMsV0FBZixFQUFqQjtBQUNBO0FBQ0EsZ0JBQU1oQyxjQUFjLEtBQUtMLFFBQUwsQ0FBY0UscUJBQWQsRUFBcEI7O0FBRUFHLHdCQUFZQyxPQUFaLEdBQXNCMkYsU0FBUzNGLE9BQS9CO0FBQ0EsZ0JBQUksdUJBQXVCMkYsUUFBM0IsRUFBcUM7QUFDakMsd0NBQVM1RixXQUFULEVBQXNCNEYsU0FBU3NCLGlCQUEvQjtBQUNIO0FBQ0Qsb0NBQVNsSCxXQUFULEVBQXNCLEVBQUVtSCxNQUFNdkIsU0FBU3dCLFdBQWpCLEVBQXRCOztBQUVBLGlCQUFLMUgsR0FBTCxDQUFTWSxLQUFULENBQWUsOEJBQWY7QUFDQSx5QkFBR3dHLGFBQUgsQ0FDSSxLQUFLckgsQ0FBTCxDQUFPZSxHQUFQLENBQVdDLEtBQVgsQ0FBaUJDLFdBQWpCLENBQTZCVixXQURqQyxFQUM4Qyx5QkFBZUEsV0FBZixFQUE0QixJQUE1QixFQUFrQyxDQUFsQyxDQUQ5QztBQUdBLGlCQUFLQSxXQUFMLEdBQW1CQSxXQUFuQjtBQUNIOztBQUVEOzs7Ozs7bURBRzJCO0FBQ3ZCLGlCQUFLTixHQUFMLENBQVNZLEtBQVQsQ0FBZSwrQkFBZjtBQUNBLGdCQUFNc0YsV0FBVyxLQUFLbkcsQ0FBTCxDQUFPc0MsT0FBUCxDQUFlQyxXQUFmLEVBQWpCOztBQUVBO0FBQ0E0RCxxQkFBU3lCLGNBQVQsR0FBMEIsS0FBSzVILENBQUwsQ0FBT3NDLE9BQVAsQ0FBZXVGLGNBQWYsRUFBMUI7QUFDQTFCLHFCQUFTMUYsb0JBQVQsR0FBZ0MsS0FBS0Esb0JBQXJDOztBQUVBO0FBQ0EwRixxQkFBU3BGLEdBQVQsR0FBZ0IsS0FBS2YsQ0FBTCxDQUFPZSxHQUFQLENBQVcrQyxpQkFBWCxFQUFELEdBQ1gsTUFEVyxHQUNGLEtBRGI7O0FBR0FxQyxxQkFBUzJCLG9CQUFULEdBQWdDLEtBQUs5SCxDQUFMLENBQU9rQyxVQUFQLEVBQWhDOztBQUVBLHlCQUFHbUYsYUFBSCxDQUNJLEtBQUtySCxDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQitHLFVBQWpCLENBQTRCNUIsUUFEaEMsRUFDMEMseUJBQWVBLFFBQWYsRUFBeUIsSUFBekIsRUFBK0IsQ0FBL0IsQ0FEMUM7QUFHSDs7QUFFRDs7Ozs7OzRDQUdvQjtBQUFBOztBQUNoQixpQkFBS2xHLEdBQUwsQ0FBU1UsSUFBVCxDQUFjLDBCQUFkO0FBQ0EsbUJBQU8sc0JBQVksVUFBQ0MsT0FBRCxFQUFVa0YsTUFBVixFQUFxQjtBQUNwQywrQkFBS3pFLGFBQUwsQ0FDSSxPQUFLckIsQ0FBTCxDQUFPZSxHQUFQLENBQVdDLEtBQVgsQ0FBaUIrRyxVQUFqQixDQUE0QnRHLElBRGhDLEVBRUksT0FBS3pCLENBQUwsQ0FBT2UsR0FBUCxDQUFXQyxLQUFYLENBQWlCQyxXQUFqQixDQUE2QitHLFdBRmpDLEVBR0ksWUFBTTtBQUNGLDJCQUFLL0gsR0FBTCxDQUFTNEIsT0FBVCxDQUFpQiw2QkFBakI7QUFDQSwyQkFBSzdCLENBQUwsQ0FBT3dGLEtBQVAsQ0FDS0csYUFETCxDQUNtQixLQURuQixFQUMwQixPQUFLM0YsQ0FBTCxDQUFPZSxHQUFQLENBQVdDLEtBQVgsQ0FBaUIrRyxVQUFqQixDQUE0QnRHLElBRHRELEVBRUt3RyxJQUZMLENBRVUsWUFBTTtBQUNSckg7QUFDSCxxQkFKTCxFQUtLc0gsS0FMTCxDQUtXLFVBQUNoRixDQUFELEVBQU87QUFDVjRDLCtCQUFPNUMsQ0FBUDtBQUNILHFCQVBMO0FBUUgsaUJBYkw7QUFlSCxhQWhCTSxDQUFQO0FBaUJIOztBQUVEOzs7Ozs7bURBRzJCO0FBQ3ZCLGlCQUFLakQsR0FBTCxDQUFTNEIsT0FBVCxDQUFpQix3Q0FBakI7QUFDQSw4QkFBTXNHLEVBQU4sQ0FBUyxLQUFULEVBQWdCLEtBQUtuSSxDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQnNCLE9BQWpCLENBQXlCYixJQUF6QyxFQUErQyxLQUFLekIsQ0FBTCxDQUFPZSxHQUFQLENBQVdDLEtBQVgsQ0FBaUIrRyxVQUFqQixDQUE0QnRHLElBQTNFO0FBQ0E7QUFDQSwwQkFBSUQsSUFBSixDQUFTLENBQ0wsZUFBS0wsSUFBTCxDQUFVLEtBQUtuQixDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQitHLFVBQWpCLENBQTRCdEcsSUFBdEMsRUFBNEMsSUFBNUMsRUFBa0QsV0FBbEQsQ0FESyxDQUFUO0FBR0g7O0FBR0Q7Ozs7Ozs2Q0FHcUI7QUFDakIsaUJBQUt4QixHQUFMLENBQVNVLElBQVQsQ0FBYywyQkFBZDs7QUFFQSxnQkFBTXdGLFdBQVcsS0FBS25HLENBQUwsQ0FBT3NDLE9BQVAsQ0FBZUMsV0FBZixFQUFqQjtBQUNBLGdCQUFNTyxVQUFVLG1CQUFtQnFELFFBQW5CLEdBQThCQSxTQUFTaUMsYUFBdkMsR0FBdUQsRUFBdkU7QUFDQXRGLG9CQUFRdUYsVUFBUixHQUFxQixJQUFyQjtBQUNBLGdCQUFNQyxtQkFBbUIsWUFBWW5DLFFBQVosSUFBd0IsQ0FBQyxDQUFDQSxTQUFTb0MsTUFBNUQ7O0FBRUE7QUFDQTs7QUFFQTtBQUNBLGdCQUFNQyxTQUFVRixvQkFBb0JuQyxTQUFTcEYsR0FBVCxLQUFpQixNQUF0QyxzREFBZjs7QUFHQSwyQkFBS1MsSUFBTCxDQUFhLEtBQUt4QixDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQitHLFVBQWpCLENBQTRCdEcsSUFBekMsZUFBeURrRCxPQUF6RCxDQUFpRSxVQUFDOEQsSUFBRCxFQUFVO0FBQUEseUNBQ3hELGtDQUFrQkEsSUFBbEIsRUFBd0I7QUFDbkNDLDZCQUFTLENBQUNGLE1BQUQ7QUFEMEIsaUJBQXhCLENBRHdEO0FBQUEsb0JBQ2pFdEMsSUFEaUUsc0JBQ2pFQSxJQURpRTs7QUFJdkUsb0JBQUlDLFNBQVNwRixHQUFULEtBQWlCLE1BQWpCLElBQTJCdUgsZ0JBQS9CLEVBQWlEO0FBQzdDcEMsMkJBQU8sbUJBQU95QyxNQUFQLENBQWN6QyxJQUFkLEVBQW9CcEQsT0FBcEIsRUFBNkJvRCxJQUFwQztBQUNIO0FBQ0QsNkJBQUdtQixhQUFILENBQWlCb0IsSUFBakIsRUFBdUJ2QyxJQUF2QjtBQUNILGFBUkQ7QUFTSDs7QUFFRDs7Ozs7Ozs7Ozs7Ozs7OztBQUtJLHFDQUFLakcsR0FBTCxDQUFTVSxJQUFULENBQWMsOEJBQWQ7O0FBRUE7Ozs7dUNBR1UsS0FBS1gsQ0FBTCxDQUFPd0YsS0FBUCxDQUFhRyxhQUFiLENBQTJCLEtBQTNCLEVBQWtDLEtBQUszRixDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQkMsV0FBakIsQ0FBNkIySCxTQUEvRCxDOzs7Ozs7Ozs7c0NBRUEsSUFBSXRELEtBQUosYzs7OztBQUdWLGtEQUFNdUQsS0FBTixDQUFZLEtBQUs3SSxDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQkMsV0FBakIsQ0FBNkIySCxTQUF6Qzs7QUFFTUUsdUMsR0FBVSxLQUFLOUksQ0FBTCxDQUFPc0MsT0FBUCxDQUFleUcsbUJBQWYsRTs7QUFFaEI7O0FBQ0FELHdDQUFRbkUsT0FBUixDQUFnQixVQUFDOUUsTUFBRCxFQUFZO0FBQ3hCLHdDQUFNbUosZUFBZW5KLE1BQXJCO0FBQ0Esd0NBQUksYUFBYW1KLFlBQWpCLEVBQStCO0FBQzNCLDRDQUFJLENBQUMzQyxNQUFNQyxPQUFOLENBQWMwQyxhQUFhQyxPQUEzQixDQUFMLEVBQTBDO0FBQ3RDRCx5REFBYUMsT0FBYixHQUF1QixDQUFDRCxhQUFhQyxPQUFkLENBQXZCO0FBQ0g7QUFDREQscURBQWFDLE9BQWIsQ0FBcUJ0RSxPQUFyQixDQUE2QixVQUFDOEQsSUFBRCxFQUFVO0FBQ25DLG1EQUFLeEksR0FBTCxDQUFTWSxLQUFULGdCQUE0QjRILElBQTVCLGNBQXlDNUksT0FBTzZILElBQWhEO0FBQ0EsZ0RBQU13QixXQUFXLGVBQUsvSCxJQUFMLENBQ2IsT0FBS25CLENBQUwsQ0FBT2UsR0FBUCxDQUFXQyxLQUFYLENBQWlCK0csVUFBakIsQ0FBNEJaLE9BRGYsRUFDd0I2QixhQUFhRyxPQURyQyxFQUM4Q1YsSUFEOUMsQ0FBakI7QUFFQSxnREFBTVcsa0JBQWtCLGVBQUtqSSxJQUFMLENBQ3BCLE9BQUtuQixDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQkMsV0FBakIsQ0FBNkIySCxTQURULEVBQ29CSSxhQUFhRyxPQURqQyxDQUF4Qjs7QUFHQSxnREFBSSxDQUFDLE9BQUtuSixDQUFMLENBQU93RixLQUFQLENBQWFDLE1BQWIsQ0FBb0IyRCxlQUFwQixDQUFMLEVBQTJDO0FBQ3ZDLGtFQUFNUCxLQUFOLENBQVlPLGVBQVo7QUFDSDtBQUNELDhEQUFNdEksRUFBTixDQUFTb0ksUUFBVCxFQUFtQkUsZUFBbkI7QUFDSCx5Q0FYRDtBQVlIO0FBQ0osaUNBbkJEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztrQkEvakJhckosVyIsImZpbGUiOiJlbGVjdHJvbkFwcC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBhc2FyIGZyb20gJ2FzYXInO1xuaW1wb3J0IGFzc2lnbkluIGZyb20gJ2xvZGFzaC9hc3NpZ25Jbic7XG5pbXBvcnQgeyB0cmFuc2Zvcm1GaWxlU3luYyB9IGZyb20gJ2JhYmVsLWNvcmUnO1xuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IGRlbCBmcm9tICdkZWwnO1xuaW1wb3J0IGVzMjAxNVByZXNldCBmcm9tICdiYWJlbC1wcmVzZXQtZXMyMDE1JztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgZ2xvYiBmcm9tICdnbG9iJztcbmltcG9ydCBub2RlNlByZXNldCBmcm9tICdiYWJlbC1wcmVzZXQtbm9kZTYnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgc2hlbGwgZnJvbSAnc2hlbGxqcyc7XG5pbXBvcnQgc3Bhd24gZnJvbSAnY3Jvc3Mtc3Bhd24nO1xuaW1wb3J0IHVnbGlmeSBmcm9tICd1Z2xpZnktanMnO1xuXG5cbmltcG9ydCBMb2cgZnJvbSAnLi9sb2cnO1xuaW1wb3J0IEVsZWN0cm9uQXBwU2NhZmZvbGQgZnJvbSAnLi9lbGVjdHJvbkFwcFNjYWZmb2xkJztcbmltcG9ydCBEZXBlbmRlbmNpZXNNYW5hZ2VyIGZyb20gJy4vZGVwZW5kZW5jaWVzTWFuYWdlcic7XG5cbnNoZWxsLmNvbmZpZy5mYXRhbCA9IHRydWU7XG5cbi8qKlxuICogUmVwcmVzZW50cyB0aGUgLmRlc2t0b3AgZGlyIHNjYWZmb2xkLlxuICogQGNsYXNzXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEVsZWN0cm9uQXBwIHtcblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7TWV0ZW9yRGVza3RvcH0gJCAtIGNvbnRleHRcbiAgICAgKiBAY29uc3RydWN0b3JcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcigkKSB7XG4gICAgICAgIHRoaXMubG9nID0gbmV3IExvZygnZWxlY3Ryb25BcHAnKTtcbiAgICAgICAgdGhpcy5zY2FmZm9sZCA9IG5ldyBFbGVjdHJvbkFwcFNjYWZmb2xkKCQpO1xuICAgICAgICB0aGlzLmRlcHNNYW5hZ2VyID0gbmV3IERlcGVuZGVuY2llc01hbmFnZXIoXG4gICAgICAgICAgICAkLFxuICAgICAgICAgICAgdGhpcy5zY2FmZm9sZC5nZXREZWZhdWx0UGFja2FnZUpzb24oKS5kZXBlbmRlbmNpZXNcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy4kID0gJDtcbiAgICAgICAgdGhpcy5tZXRlb3JBcHAgPSB0aGlzLiQubWV0ZW9yQXBwO1xuICAgICAgICB0aGlzLnBhY2thZ2VKc29uID0gbnVsbDtcbiAgICAgICAgdGhpcy52ZXJzaW9uID0gbnVsbDtcbiAgICAgICAgdGhpcy5jb21wYXRpYmlsaXR5VmVyc2lvbiA9IG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTWFrZXMgYW4gYXBwLmFzYXIgZnJvbSB0aGUgc2tlbGV0b24gYXBwLlxuICAgICAqIEBwcm9wZXJ0eSB7QXJyYXl9IGV4Y2x1ZGVGcm9tRGVsIC0gbGlzdCBvZiBwYXRocyB0byBleGNsdWRlIGZyb20gZGVsZXRpbmdcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICAgKi9cbiAgICBwYWNrU2tlbGV0b25Ub0FzYXIoZXhjbHVkZUZyb21EZWwgPSBbXSkge1xuICAgICAgICB0aGlzLmxvZy5pbmZvKCdwYWNraW5nIHNrZWxldG9uIGFwcCBhbmQgbm9kZV9tb2R1bGVzIHRvIGFzYXIgYXJjaGl2ZScpO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIC8vIFdlIHdhbnQgdG8gcGFjayBza2VsZXRvbiBhcHAgYW5kIG5vZGVfbW9kdWxlcyB0b2dldGhlciwgc28gd2UgbmVlZCB0byB0ZW1wb3JhcmlseVxuICAgICAgICAgICAgLy8gbW92ZSBub2RlX21vZHVsZXMgdG8gYXBwIGRpci5cbiAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdtb3Zpbmcgbm9kZV9tb2R1bGVzIHRvIGFwcCBkaXInKTtcbiAgICAgICAgICAgIHNoZWxsLm12KFxuICAgICAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAubm9kZU1vZHVsZXMsXG4gICAgICAgICAgICAgICAgcGF0aC5qb2luKHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAuYXBwUm9vdCwgJ25vZGVfbW9kdWxlcycpXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhpcy5sb2cuZGVidWcoJ3BhY2tpbmcnKTtcbiAgICAgICAgICAgIGFzYXIuY3JlYXRlUGFja2FnZShcbiAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLmFwcFJvb3QsXG4gICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5hcHBBc2FyLFxuICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gTGV0cyBtb3ZlIHRoZSBub2RlX21vZHVsZXMgYmFjay5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2cuZGVidWcoJ21vdmluZyBub2RlX21vZHVsZXMgYmFjayBmcm9tIGFwcCBkaXInKTtcbiAgICAgICAgICAgICAgICAgICAgc2hlbGwubXYoXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXRoLmpvaW4odGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5hcHBSb290LCAnbm9kZV9tb2R1bGVzJyksXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLm5vZGVNb2R1bGVzXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdkZWxldGluZyBzb3VyY2UgZmlsZXMnKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhjbHVkZSA9IEFycmF5LmNvbmNhdChbXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLm5vZGVNb2R1bGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5hcHBBc2FyLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5wYWNrYWdlSnNvblxuICAgICAgICAgICAgICAgICAgICBdLCBleGNsdWRlRnJvbURlbCk7XG5cbiAgICAgICAgICAgICAgICAgICAgZGVsLnN5bmMoXG4gICAgICAgICAgICAgICAgICAgICAgICBBcnJheS5jb25jYXQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgW2Ake3RoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAucm9vdH0ke3BhdGguc2VwfSpgXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNsdWRlLm1hcChwYXRoVG9FeGNsdWRlID0+IGAhJHtwYXRoVG9FeGNsdWRlfWApXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxjdWxhdGVzIGEgbWQ1IGZyb20gYWxsIGRlcGVuZGVuY2llcy5cbiAgICAgKi9cbiAgICBjYWxjdWxhdGVDb21wYXRpYmlsaXR5VmVyc2lvbigpIHtcbiAgICAgICAgdGhpcy5sb2cudmVyYm9zZSgnY2FsY3VsYXRpbmcgY29tcGF0aWJpbGl0eSB2ZXJzaW9uJyk7XG4gICAgICAgIGNvbnN0IG1kNSA9IGNyeXB0by5jcmVhdGVIYXNoKCdtZDUnKTtcbiAgICAgICAgbGV0IGRlcGVuZGVuY2llcyA9IEFycmF5LnNvcnQoT2JqZWN0LmtleXModGhpcy5wYWNrYWdlSnNvbi5kZXBlbmRlbmNpZXMpKTtcbiAgICAgICAgZGVwZW5kZW5jaWVzID0gZGVwZW5kZW5jaWVzLm1hcChkZXBlbmRlbmN5ID0+XG4gICAgICAgICAgICBgJHtkZXBlbmRlbmN5fToke3RoaXMucGFja2FnZUpzb24uZGVwZW5kZW5jaWVzW2RlcGVuZGVuY3ldfWBcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3QgbWFpbkNvbXBhdGliaWxpdHlWZXJzaW9uID0gdGhpcy4kLmdldFZlcnNpb24oKS5zcGxpdCgnLicpO1xuICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnbWV0ZW9yLWRlc2t0b3AgY29tcGF0aWJpbGl0eSB2ZXJzaW9uIGlzICcsXG4gICAgICAgICAgICBgJHttYWluQ29tcGF0aWJpbGl0eVZlcnNpb25bMF19LiR7bWFpbkNvbXBhdGliaWxpdHlWZXJzaW9uWzFdfWApO1xuICAgICAgICBkZXBlbmRlbmNpZXMucHVzaChcbiAgICAgICAgICAgIGBtZXRlb3ItZGVza3RvcDoke21haW5Db21wYXRpYmlsaXR5VmVyc2lvblswXX0uJHttYWluQ29tcGF0aWJpbGl0eVZlcnNpb25bMV19YCk7XG5cbiAgICAgICAgY29uc3QgZGVza3RvcENvbXBhdGliaWxpdHlWZXJzaW9uID0gdGhpcy4kLmRlc2t0b3AuZ2V0U2V0dGluZ3MoKS52ZXJzaW9uLnNwbGl0KCcuJylbMF07XG4gICAgICAgIHRoaXMubG9nLmRlYnVnKCcuZGVza3RvcCBjb21wYXRpYmlsaXR5IHZlcnNpb24gaXMgJywgZGVza3RvcENvbXBhdGliaWxpdHlWZXJzaW9uKTtcbiAgICAgICAgZGVwZW5kZW5jaWVzLnB1c2goXG4gICAgICAgICAgICBgZGVza3RvcC1hcHA6JHtkZXNrdG9wQ29tcGF0aWJpbGl0eVZlcnNpb259YCk7XG5cbiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk1FVEVPUl9ERVNLVE9QX0RFQlVHX0RFU0tUT1BfQ09NUEFUSUJJTElUWV9WRVJTSU9OKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZyhgY29tcGF0aWJpbGl0eSB2ZXJzaW9uIGNhbGN1bGF0ZWQgZnJvbSAke0pTT04uc3RyaW5naWZ5KGRlcGVuZGVuY2llcyl9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBtZDUudXBkYXRlKEpTT04uc3RyaW5naWZ5KGRlcGVuZGVuY2llcykpO1xuICAgICAgICB0aGlzLmNvbXBhdGliaWxpdHlWZXJzaW9uID0gbWQ1LmRpZ2VzdCgnaGV4Jyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUnVucyBhbGwgbmVjZXNzYXJ5IHRhc2tzIHRvIGJ1aWxkIHRoZSBkZXNrdG9waWZpZWQgYXBwLlxuICAgICAqL1xuICAgIGFzeW5jIGJ1aWxkKHJ1biA9IGZhbHNlKSB7XG4gICAgICAgIC8vIFRPRE86IHJlZmFjdG9yIHRvIGEgdGFzayBydW5uZXJcbiAgICAgICAgdGhpcy5sb2cuaW5mbygnc2NhZmZvbGRpbmcnKTtcblxuICAgICAgICBpZiAoIXRoaXMuJC5kZXNrdG9wLmNoZWNrKCkpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy4kLmVudi5vcHRpb25zLnNjYWZmb2xkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ3NlZW1zIHRoYXQgeW91IGRvIG5vdCBoYXZlIGEgLmRlc2t0b3AgZGlyIGluIHlvdXIgcHJvamVjdCBvciBpdCBpcycgK1xuICAgICAgICAgICAgICAgICAgICAnIGNvcnJ1cHRlZC4gUnVuIFxcJ25wbSBydW4gZGVza3RvcCAtLSBpbml0XFwnIHRvIGdldCBhIG5ldyBvbmUuJyk7XG4gICAgICAgICAgICAgICAgLy8gRG8gbm90IGZhaWwsIHNvIHRoYXQgbnBtIHdpbGwgbm90IHByaW50IGhpcyBlcnJvciBzdHVmZiB0byBjb25zb2xlLlxuICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy4kLmRlc2t0b3Auc2NhZmZvbGQoKTtcbiAgICAgICAgICAgICAgICB0aGlzLiQubWV0ZW9yQXBwLnVwZGF0ZUdpdElnbm9yZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMuJC5tZXRlb3JBcHAudXBkYXRlR2l0SWdub3JlKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLndhcm4oYGVycm9yIG9jY3VycmVkIHdoaWxlIGFkZGluZyAke3RoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAucm9vdE5hbWV9YCArXG4gICAgICAgICAgICAgICAgJ3RvIC5naXRpZ25vcmU6ICcsIGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuJC5tZXRlb3JBcHAuZW5zdXJlRGVza3RvcEhDUFBhY2thZ2VzKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdlcnJvciB3aGlsZSBjaGVja2luZyBmb3IgcmVxdWlyZWQgcGFja2FnZXM6ICcsIGUpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2NhZmZvbGQubWFrZSgpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignZXJyb3Igd2hpbGUgc2NhZmZvbGRpbmc6ICcsIGUpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlUGFja2FnZUpzb25GaWVsZHMoKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ2Vycm9yIHdoaWxlIHVwZGF0aW5nIHBhY2thZ2UuanNvbjogJywgZSk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVEZXBlbmRlbmNpZXNMaXN0KCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdlcnJvciB3aGlsZSBtZXJnaW5nIGRlcGVuZGVuY2llcyBsaXN0OiAnLCBlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLmNhbGN1bGF0ZUNvbXBhdGliaWxpdHlWZXJzaW9uKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdlcnJvciB3aGlsZSBjYWxjdWxhdGluZyBjb21wYXRpYmlsaXR5IHZlcnNpb246ICcsIGUpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vIElmIHRoZXJlIGlzIGEgdGVtcG9yYXJ5IG5vZGVfbW9kdWxlcyBmb2xkZXIgYW5kIG5vIG5vZGVfbW9kdWxlcyBmb2xkZXIsIHdlIHdpbGxcbiAgICAgICAgICAgIC8vIHJlc3RvcmUgaXQsIGFzIGl0IG1pZ2h0IGJlIGEgbGVmdG92ZXIgZnJvbSBhbiBpbnRlcnJ1cHRlZCBmbG93LlxuICAgICAgICAgICAgYXdhaXQgdGhpcy5oYW5kbGVUZW1wb3JhcnlOb2RlTW9kdWxlcygpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignZXJyb3Igb2NjdXJyZWQgd2hpbGUgaGFuZGxpbmcgdGVtcG9yYXJ5IG5vZGVfbW9kdWxlczogJywgZSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5lbnN1cmVEZXBzKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdlcnJvciBvY2N1cnJlZCB3aGlsZSBydW5uaW5nIG5wbTogJywgZSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5lbnN1cmVNZXRlb3JEZXBlbmRlbmNpZXMoKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ2Vycm9yIG9jY3VycmVkIHdoaWxlIHJ1bm5pbmcgbnBtOiAnLCBlKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnJlYnVpbGREZXBzKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdlcnJvciBvY2N1cnJlZCB3aGlsZSByZWJ1aWxkaW5nIG5hdGl2ZSBub2RlIG1vZHVsZXM6ICcsIGUpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuJC5lbnYuaXNQcm9kdWN0aW9uQnVpbGQoKSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnBhY2tTa2VsZXRvblRvQXNhcigpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdlcnJvciB3aGlsZSBwYWNraW5nIHNrZWxldG9uIHRvIGFzYXI6ICcsIGUpO1xuICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFRPRE86IGZpbmQgYSB3YXkgdG8gYXZvaWQgY29weWluZyAuZGVza3RvcCB0byBhIHRlbXAgbG9jYXRpb25cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMuY29weURlc2t0b3BUb0Rlc2t0b3BUZW1wKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdlcnJvciB3aGlsZSBjb3B5aW5nIC5kZXNrdG9wIHRvIGEgdGVtcG9yYXJ5IGxvY2F0aW9uOiAnLCBlKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVNldHRpbmdzSnNvbkZpZWxkcygpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignZXJyb3Igd2hpbGUgdXBkYXRpbmcgc2V0dGluZ3MuanNvbjogJywgZSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5leGNsdWRlRmlsZXNGcm9tQXJjaGl2ZSgpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignZXJyb3Igd2hpbGUgZXhjbHVkaW5nIGZpbGVzIGZyb20gcGFja2luZyB0byBhc2FyOiAnLCBlKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLnRyYW5zcGlsZUFuZE1pbmlmeSgpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignZXJyb3Igd2hpbGUgdHJhbnNwaWxpbmcgb3IgbWluaWZ5aW5nOiAnLCBlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnBhY2tEZXNrdG9wVG9Bc2FyKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdlcnJvciBvY2N1cnJlZCB3aGlsZSBwYWNraW5nIC5kZXNrdG9wIHRvIGFzYXI6ICcsIGUpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZ2V0TWV0ZW9yQ2xpZW50QnVpbGQoKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ2Vycm9yIG9jY3VycmVkIGR1cmluZyBnZXR0aW5nIG1ldGVvciBtb2JpbGUgYnVpbGQ6ICcsIGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJ1bikge1xuICAgICAgICAgICAgdGhpcy5sb2cuaW5mbygncnVubmluZycpO1xuICAgICAgICAgICAgdGhpcy4kLmVsZWN0cm9uLnJ1bigpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2cuaW5mbygnYnVpbHQnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGVuc3VyZU1ldGVvckRlcGVuZGVuY2llcygpIHtcbiAgICAgICAgY29uc3QgcGFja2FnZXMgPSBbXTtcbiAgICAgICAgY29uc3QgcGFja2FnZXNXaXRoVmVyc2lvbiA9IFtdO1xuICAgICAgICBsZXQgcGx1Z2lucyA9ICdwbHVnaW5zIFsnO1xuXG4gICAgICAgIE9iamVjdC5rZXlzKHRoaXMuJC5kZXNrdG9wLmdldERlcGVuZGVuY2llcygpLnBsdWdpbnMpLmZvckVhY2goKHBsdWdpbikgPT4ge1xuICAgICAgICAgICAgLy8gUmVhZCBwYWNrYWdlLmpzb24gb2YgdGhlIHBsdWdpbi5cbiAgICAgICAgICAgIGNvbnN0IHBhY2thZ2VKc29uID1cbiAgICAgICAgICAgICAgICBKU09OLnBhcnNlKFxuICAgICAgICAgICAgICAgICAgICBmcy5yZWFkRmlsZVN5bmMoXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXRoLmpvaW4oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5ub2RlTW9kdWxlcywgcGx1Z2luLCAncGFja2FnZS5qc29uJyksXG4gICAgICAgICAgICAgICAgICAgICAgICAndXRmOCdcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmICgnbWV0ZW9yRGVwZW5kZW5jaWVzJyBpbiBwYWNrYWdlSnNvbiAmJiB0eXBlb2YgcGFja2FnZUpzb24ubWV0ZW9yRGVwZW5kZW5jaWVzID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgIHBsdWdpbnMgKz0gYCR7cGx1Z2lufSwgYDtcbiAgICAgICAgICAgICAgICBwYWNrYWdlcy51bnNoaWZ0KC4uLk9iamVjdC5rZXlzKHBhY2thZ2VKc29uLm1ldGVvckRlcGVuZGVuY2llcykpO1xuICAgICAgICAgICAgICAgIHBhY2thZ2VzV2l0aFZlcnNpb24udW5zaGlmdCguLi5wYWNrYWdlcy5tYXAoKHBhY2thZ2VOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYWNrYWdlSnNvbi5tZXRlb3JEZXBlbmRlbmNpZXNbcGFja2FnZU5hbWVdID09PSAnQHZlcnNpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYCR7cGFja2FnZU5hbWV9QCR7cGFja2FnZUpzb24udmVyc2lvbn1gO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgJHtwYWNrYWdlTmFtZX1AJHtwYWNrYWdlSnNvbi5tZXRlb3JEZXBlbmRlbmNpZXNbcGFja2FnZU5hbWVdfWA7XG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAocGFja2FnZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcGx1Z2lucyA9IGAke3BsdWdpbnMuc3Vic3RyKDAsIHBsdWdpbnMubGVuZ3RoIC0gMil9XWA7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuJC5tZXRlb3JBcHAuZW5zdXJlUGFja2FnZXMocGFja2FnZXMsIHBhY2thZ2VzV2l0aFZlcnNpb24sIHBsdWdpbnMpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEJ1aWxkcyBtZXRlb3IgYXBwLlxuICAgICAqL1xuICAgIGFzeW5jIGdldE1ldGVvckNsaWVudEJ1aWxkKCkge1xuICAgICAgICBhd2FpdCB0aGlzLiQubWV0ZW9yQXBwLmJ1aWxkKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgaGFuZGxlVGVtcG9yYXJ5Tm9kZU1vZHVsZXMoKSB7XG4gICAgICAgIGlmICh0aGlzLiQudXRpbHMuZXhpc3RzKHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAudG1wTm9kZU1vZHVsZXMpKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuJC51dGlscy5leGlzdHModGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5ub2RlTW9kdWxlcykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnbW92aW5nIHRlbXAgbm9kZV9tb2R1bGVzIGJhY2snKTtcbiAgICAgICAgICAgICAgICBzaGVsbC5tdihcbiAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC50bXBOb2RlTW9kdWxlcyxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5ub2RlTW9kdWxlc1xuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIElmIHRoZXJlIGlzIGEgbm9kZV9tb2R1bGVzIGZvbGRlciwgd2Ugc2hvdWxkIGNsZWFyIHRoZSB0ZW1wb3Jhcnkgb25lLlxuICAgICAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdjbGVhcmluZyB0ZW1wIG5vZGVfbW9kdWxlcyBiZWNhdXNlIG5ldyBvbmUgaXMgYWxyZWFkeSBjcmVhdGVkJyk7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy4kLnV0aWxzLnJtV2l0aFJldHJpZXMoXG4gICAgICAgICAgICAgICAgICAgICAgICAnLXJmJywgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC50bXBOb2RlTW9kdWxlcyk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogV3JhcHBlciBmb3Igc3Bhd25pbmcgbnBtLlxuICAgICAqIEBwYXJhbSB7QXJyYXl9ICBjb21tYW5kcyAtIGNvbW1hbmRzIGZvciBzcGF3blxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdGRpb1xuICAgICAqIEByZXR1cm4ge1Byb21pc2V9XG4gICAgICovXG4gICAgcnVuTnBtKGNvbW1hbmRzLCBzdGRpbyA9ICdpZ25vcmUnKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAvLyBUT0RPOiBmaW5kIGEgd2F5IHRvIHJ1biBucG0gd2l0aG91dCBkZXBlbmRpbmcgb24gaXQgY2F1c2UgaXQncyBhIGh1Z2UgZGVwZW5kZW5jeS5cbiAgICAgICAgICAgIGNvbnN0IG5wbSA9IHBhdGguam9pbihcbiAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLm1ldGVvckFwcC5yb290LCAnbm9kZV9tb2R1bGVzJywgJy5iaW4nLCAnbnBtJyk7XG4gICAgICAgICAgICB0aGlzLmxvZy52ZXJib3NlKGBleGVjdXRpbmcgbnBtICR7Y29tbWFuZHMuam9pbignICcpfWApO1xuXG4gICAgICAgICAgICBzcGF3bihucG0sIGNvbW1hbmRzLCB7XG4gICAgICAgICAgICAgICAgY3dkOiB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLnJvb3QsXG4gICAgICAgICAgICAgICAgc3RkaW9cbiAgICAgICAgICAgIH0pLm9uKCdleGl0JywgY29kZSA9PiAoXG4gICAgICAgICAgICAgICAgICAgIChjb2RlID09PSAwKSA/IHJlc29sdmUoKSA6IHJlamVjdChgbnBtIGV4aXQgY29kZSB3YXMgJHtjb2RlfWApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKiBSdW5zIG5wbSBsaW5rIGZvciBldmVyeSBwYWNrYWdlIHNwZWNpZmllZCBpbiBzZXR0aW5ncy5qc29uLT5saW5rUGFja2FnZXMuXG4gICAgICovXG4gICAgYXN5bmMgbGlua05wbVBhY2thZ2VzKCkge1xuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHRoaXMuJC5kZXNrdG9wLmdldFNldHRpbmdzKCk7XG4gICAgICAgIGNvbnN0IHByb21pc2VzID0gW107XG4gICAgICAgIGlmICgnbGlua1BhY2thZ2VzJyBpbiB0aGlzLiQuZGVza3RvcC5nZXRTZXR0aW5ncygpKSB7XG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzZXR0aW5ncy5saW5rUGFja2FnZXMpKSB7XG4gICAgICAgICAgICAgICAgc2V0dGluZ3MubGlua1BhY2thZ2VzLmZvckVhY2gocGFja2FnZU5hbWUgPT5cbiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLnJ1bk5wbShbJ2xpbmsnLCBwYWNrYWdlTmFtZV0pKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJ1bnMgbnBtIGluIHRoZSBlbGVjdHJvbiBhcHAgdG8gZ2V0IHRoZSBkZXBlbmRlbmNpZXMgaW5zdGFsbGVkLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgICAqL1xuICAgIGFzeW5jIGVuc3VyZURlcHMoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMubGlua05wbVBhY2thZ2VzKCk7XG5cbiAgICAgICAgdGhpcy5sb2cuaW5mbygnaW5zdGFsbGluZyBkZXBlbmRlbmNpZXMnKTtcbiAgICAgICAgaWYgKHRoaXMuJC51dGlscy5leGlzdHModGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5ub2RlTW9kdWxlcykpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdydW5uaW5nIG5wbSBwcnVuZSB0byB3aXBlIHVubmVlZGVkIGRlcGVuZGVuY2llcycpO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnJ1bk5wbShbJ3BydW5lJ10pO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5ydW5OcG0oWydpbnN0YWxsJ10sIHRoaXMuJC5lbnYuc3RkaW8pO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBXYXJucyBpZiBwbHVnaW5zIHZlcnNpb24gYXJlIG91dGRhdGVkIGluIGNvbXBhcmUgdG8gdGhlIG5ld2VzdCBzY2FmZm9sZC5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gcGx1Z2luc1ZlcnNpb25zIC0gY3VycmVudCBwbHVnaW5zIHZlcnNpb25zIGZyb20gc2V0dGluZ3MuanNvblxuICAgICAqL1xuICAgIGNoZWNrUGx1Z2luc1ZlcnNpb24ocGx1Z2luc1ZlcnNpb25zKSB7XG4gICAgICAgIGNvbnN0IHNldHRpbmdzSnNvbiA9IEpTT04ucGFyc2UoXG4gICAgICAgICAgICBmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKHRoaXMuJC5lbnYucGF0aHMuc2NhZmZvbGQsICdzZXR0aW5ncy5qc29uJykpXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IHNjYWZmb2xkUGx1Z2luc1ZlcnNpb24gPSB0aGlzLiQuZGVza3RvcC5nZXREZXBlbmRlbmNpZXMoc2V0dGluZ3NKc29uLCBmYWxzZSkucGx1Z2lucztcbiAgICAgICAgT2JqZWN0LmtleXMocGx1Z2luc1ZlcnNpb25zKS5mb3JFYWNoKChwbHVnaW5OYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAoc2NhZmZvbGRQbHVnaW5zVmVyc2lvbltwbHVnaW5OYW1lXSAhPT0gcGx1Z2luc1ZlcnNpb25zW3BsdWdpbk5hbWVdKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2cud2FybihgeW91IGFyZSB1c2luZyBvdXRkYXRlZCB2ZXJzaW9uICR7cGx1Z2luc1ZlcnNpb25zW3BsdWdpbk5hbWVdfSBvZiBgICtcbiAgICAgICAgICAgICAgICAgICAgYCR7cGx1Z2luTmFtZX0sIHRoZSBzdWdnZXN0ZWQgdmVyc2lvbiB0byB1c2UgaXMgYCArXG4gICAgICAgICAgICAgICAgICAgIGAke3NjYWZmb2xkUGx1Z2luc1ZlcnNpb25bcGx1Z2luTmFtZV19YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE1lcmdlcyBjb3JlIGRlcGVuZGVuY3kgbGlzdCB3aXRoIHRoZSBkZXBlbmRlbmNpZXMgZnJvbSAuZGVza3RvcC5cbiAgICAgKi9cbiAgICB1cGRhdGVEZXBlbmRlbmNpZXNMaXN0KCkge1xuICAgICAgICB0aGlzLmxvZy5pbmZvKCd1cGRhdGluZyBsaXN0IG9mIHBhY2thZ2UuanNvblxcJ3MgZGVwZW5kZW5jaWVzJyk7XG4gICAgICAgIGNvbnN0IGRlc2t0b3BEZXBlbmRlbmNpZXMgPSB0aGlzLiQuZGVza3RvcC5nZXREZXBlbmRlbmNpZXMoKTtcblxuICAgICAgICB0aGlzLmNoZWNrUGx1Z2luc1ZlcnNpb24oZGVza3RvcERlcGVuZGVuY2llcy5wbHVnaW5zKTtcblxuICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnbWVyZ2luZyBzZXR0aW5ncy5qc29uW2RlcGVuZGVuY2llc10nKTtcbiAgICAgICAgdGhpcy5kZXBzTWFuYWdlci5tZXJnZURlcGVuZGVuY2llcyhcbiAgICAgICAgICAgICdzZXR0aW5ncy5qc29uW2RlcGVuZGVuY2llc10nLFxuICAgICAgICAgICAgZGVza3RvcERlcGVuZGVuY2llcy5mcm9tU2V0dGluZ3NcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5sb2cuZGVidWcoJ21lcmdpbmcgc2V0dGluZ3MuanNvbltwbHVnaW5zXScpO1xuICAgICAgICB0aGlzLmRlcHNNYW5hZ2VyLm1lcmdlRGVwZW5kZW5jaWVzKFxuICAgICAgICAgICAgJ3NldHRpbmdzLmpzb25bcGx1Z2luc10nLFxuICAgICAgICAgICAgZGVza3RvcERlcGVuZGVuY2llcy5wbHVnaW5zXG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy5sb2cuZGVidWcoJ21lcmdpbmcgZGVwZW5kZW5jaWVzIGZyb20gbW9kdWxlcycpO1xuICAgICAgICBPYmplY3Qua2V5cyhkZXNrdG9wRGVwZW5kZW5jaWVzLm1vZHVsZXMpLmZvckVhY2gobW9kdWxlID0+XG4gICAgICAgICAgICB0aGlzLmRlcHNNYW5hZ2VyLm1lcmdlRGVwZW5kZW5jaWVzKFxuICAgICAgICAgICAgICAgIGBtb2R1bGVbJHttb2R1bGV9XWAsXG4gICAgICAgICAgICAgICAgZGVza3RvcERlcGVuZGVuY2llcy5tb2R1bGVzW21vZHVsZV1cbiAgICAgICAgICAgIClcbiAgICAgICAgKTtcblxuICAgICAgICB0aGlzLnBhY2thZ2VKc29uLmRlcGVuZGVuY2llcyA9IHRoaXMuZGVwc01hbmFnZXIuZ2V0RGVwZW5kZW5jaWVzKCk7XG5cbiAgICAgICAgdGhpcy5sb2cuZGVidWcoJ3dyaXRpbmcgdXBkYXRlZCBwYWNrYWdlLmpzb24nKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhcbiAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAucGFja2FnZUpzb24sIEpTT04uc3RyaW5naWZ5KHRoaXMucGFja2FnZUpzb24sIG51bGwsIDIpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVidWlsZCBiaW5hcnkgZGVwZW5kZW5jaWVzIGFnYWluc3QgRWxlY3Ryb24ncyBub2RlIGhlYWRlcnMuXG4gICAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAgICovXG4gICAgcmVidWlsZERlcHMoKSB7XG4gICAgICAgIGlmICghdGhpcy4kLmRlc2t0b3AuZ2V0U2V0dGluZ3MoKS5yZWJ1aWxkTmF0aXZlTm9kZU1vZHVsZXMpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLndhcm4oJ25hdGl2ZSBtb2R1bGVzIHJlYnVpbGQgaXMgdHVybmVkIG9mZiwgYmUgc3VyZSB0byB0dXJuIGl0IG9uIGlmIHlvdScgK1xuICAgICAgICAgICAgICAgICcgYWRkZWQgYW55IG5hdGl2ZSBub2RlICcgK1xuICAgICAgICAgICAgICAgICdtb2R1bGVzJyk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmxvZy5pbmZvKCdpc3N1aW5nIG5hdGl2ZSBtb2R1bGVzIHJlYnVpbGQgZnJvbSBlbGVjdHJvbi1idWlsZGVyJyk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuJC5lbGVjdHJvbkJ1aWxkZXIuaW5zdGFsbE9yUmVidWlsZCgneDY0Jyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIHBhY2thZ2UuanNvbiBmaWVsZHMgYWNjb3JkaW5nbHkgdG8gd2hhdCBpcyBzZXQgaW4gc2V0dGluZ3MuanNvbi5cbiAgICAgKlxuICAgICAqIHBhY2thZ2VKc29uLm5hbWUgPSBzZXR0aW5ncy5wcm9qZWN0TmFtZVxuICAgICAqIHBhY2thZ2VKc29uLnZlcnNpb24gPSBzZXR0aW5ncy52ZXJzaW9uXG4gICAgICogcGFja2FnZUpzb24uKiA9IHNldHRpbmdzLnBhY2thZ2VKc29uRmllbGRzXG4gICAgICovXG4gICAgdXBkYXRlUGFja2FnZUpzb25GaWVsZHMoKSB7XG4gICAgICAgIHRoaXMubG9nLnZlcmJvc2UoJ3VwZGF0aW5nIHBhY2thZ2UuanNvbiBmaWVsZHMnKTtcbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLiQuZGVza3RvcC5nZXRTZXR0aW5ncygpO1xuICAgICAgICAvKiogQHR5cGUge2Rlc2t0b3BTZXR0aW5nc30gKi9cbiAgICAgICAgY29uc3QgcGFja2FnZUpzb24gPSB0aGlzLnNjYWZmb2xkLmdldERlZmF1bHRQYWNrYWdlSnNvbigpO1xuXG4gICAgICAgIHBhY2thZ2VKc29uLnZlcnNpb24gPSBzZXR0aW5ncy52ZXJzaW9uO1xuICAgICAgICBpZiAoJ3BhY2thZ2VKc29uRmllbGRzJyBpbiBzZXR0aW5ncykge1xuICAgICAgICAgICAgYXNzaWduSW4ocGFja2FnZUpzb24sIHNldHRpbmdzLnBhY2thZ2VKc29uRmllbGRzKTtcbiAgICAgICAgfVxuICAgICAgICBhc3NpZ25JbihwYWNrYWdlSnNvbiwgeyBuYW1lOiBzZXR0aW5ncy5wcm9qZWN0TmFtZSB9KTtcblxuICAgICAgICB0aGlzLmxvZy5kZWJ1Zygnd3JpdGluZyB1cGRhdGVkIHBhY2thZ2UuanNvbicpO1xuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKFxuICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5wYWNrYWdlSnNvbiwgSlNPTi5zdHJpbmdpZnkocGFja2FnZUpzb24sIG51bGwsIDQpXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMucGFja2FnZUpzb24gPSBwYWNrYWdlSnNvbjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHNldHRpbmdzLmpzb24gd2l0aCBlbnYgKHByb2QvZGV2KSBpbmZvcm1hdGlvbiBhbmQgdmVyc2lvbnMuXG4gICAgICovXG4gICAgdXBkYXRlU2V0dGluZ3NKc29uRmllbGRzKCkge1xuICAgICAgICB0aGlzLmxvZy5kZWJ1ZygndXBkYXRpbmcgc2V0dGluZ3MuanNvbiBmaWVsZHMnKTtcbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLiQuZGVza3RvcC5nZXRTZXR0aW5ncygpO1xuXG4gICAgICAgIC8vIFNhdmUgdmVyc2lvbnMuXG4gICAgICAgIHNldHRpbmdzLmRlc2t0b3BWZXJzaW9uID0gdGhpcy4kLmRlc2t0b3AuZ2V0SGFzaFZlcnNpb24oKTtcbiAgICAgICAgc2V0dGluZ3MuY29tcGF0aWJpbGl0eVZlcnNpb24gPSB0aGlzLmNvbXBhdGliaWxpdHlWZXJzaW9uO1xuXG4gICAgICAgIC8vIFBhc3MgaW5mb3JtYXRpb24gYWJvdXQgYnVpbGQgdHlwZSB0byB0aGUgc2V0dGluZ3MuanNvbi5cbiAgICAgICAgc2V0dGluZ3MuZW52ID0gKHRoaXMuJC5lbnYuaXNQcm9kdWN0aW9uQnVpbGQoKSkgP1xuICAgICAgICAgICAgJ3Byb2QnIDogJ2Rldic7XG5cbiAgICAgICAgc2V0dGluZ3MubWV0ZW9yRGVza3RvcFZlcnNpb24gPSB0aGlzLiQuZ2V0VmVyc2lvbigpO1xuXG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmMoXG4gICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmRlc2t0b3BUbXAuc2V0dGluZ3MsIEpTT04uc3RyaW5naWZ5KHNldHRpbmdzLCBudWxsLCA0KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENvcGllcyBmaWxlcyBmcm9tIHByZXBhcmVkIC5kZXNrdG9wIHRvIGRlc2t0b3AuYXNhciBpbiBlbGVjdHJvbiBhcHAuXG4gICAgICovXG4gICAgcGFja0Rlc2t0b3BUb0FzYXIoKSB7XG4gICAgICAgIHRoaXMubG9nLmluZm8oJ3BhY2tpbmcgLmRlc2t0b3AgdG8gYXNhcicpO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgYXNhci5jcmVhdGVQYWNrYWdlKFxuICAgICAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMuZGVza3RvcFRtcC5yb290LFxuICAgICAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAuZGVza3RvcEFzYXIsXG4gICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZy52ZXJib3NlKCdjbGVhcmluZyB0ZW1wb3JhcnkgLmRlc2t0b3AnKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy4kLnV0aWxzXG4gICAgICAgICAgICAgICAgICAgICAgICAucm1XaXRoUmV0cmllcygnLXJmJywgdGhpcy4kLmVudi5wYXRocy5kZXNrdG9wVG1wLnJvb3QpXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE1ha2VzIGEgdGVtcG9yYXJ5IGNvcHkgb2YgLmRlc2t0b3AuXG4gICAgICovXG4gICAgY29weURlc2t0b3BUb0Rlc2t0b3BUZW1wKCkge1xuICAgICAgICB0aGlzLmxvZy52ZXJib3NlKCdjb3B5aW5nIC5kZXNrdG9wIHRvIHRlbXBvcmFyeSBsb2NhdGlvbicpO1xuICAgICAgICBzaGVsbC5jcCgnLXJmJywgdGhpcy4kLmVudi5wYXRocy5kZXNrdG9wLnJvb3QsIHRoaXMuJC5lbnYucGF0aHMuZGVza3RvcFRtcC5yb290KTtcbiAgICAgICAgLy8gUmVtb3ZlIHRlc3QgZmlsZXMuXG4gICAgICAgIGRlbC5zeW5jKFtcbiAgICAgICAgICAgIHBhdGguam9pbih0aGlzLiQuZW52LnBhdGhzLmRlc2t0b3BUbXAucm9vdCwgJyoqJywgJyoudGVzdC5qcycpXG4gICAgICAgIF0pO1xuICAgIH1cblxuXG4gICAgLyoqXG4gICAgICogUnVucyBiYWJlbCBhbmQgdWdsaWZ5IG92ZXIgLmRlc2t0b3AgaWYgcmVxdWVzdGVkLlxuICAgICAqL1xuICAgIHRyYW5zcGlsZUFuZE1pbmlmeSgpIHtcbiAgICAgICAgdGhpcy5sb2cuaW5mbygndHJhbnNwaWxpbmcgYW5kIHVnbGlmeWluZycpO1xuXG4gICAgICAgIGNvbnN0IHNldHRpbmdzID0gdGhpcy4kLmRlc2t0b3AuZ2V0U2V0dGluZ3MoKTtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9ICd1Z2xpZnlPcHRpb25zJyBpbiBzZXR0aW5ncyA/IHNldHRpbmdzLnVnbGlmeU9wdGlvbnMgOiB7fTtcbiAgICAgICAgb3B0aW9ucy5mcm9tU3RyaW5nID0gdHJ1ZTtcbiAgICAgICAgY29uc3QgdWdsaWZ5aW5nRW5hYmxlZCA9ICd1Z2xpZnknIGluIHNldHRpbmdzICYmICEhc2V0dGluZ3MudWdsaWZ5O1xuXG4gICAgICAgIC8vIFVuZm9ydHVuYXRlbHkgYHJlaWZ5YCB3aWxsIG5vdCB3b3JrIHdoZW4gd2UgcmVxdWlyZSBhIC5qcyBmaWxlIGZyb20gYW4gYXNhciBhcmNoaXZlLlxuICAgICAgICAvLyBTbyBoZXJlIHdlIHdpbGwgdHJhbnNwaWxlIC5kZXNrdG9wIHRvIGhhdmUgdGhlIEVTNiBtb2R1bGVzIHdvcmtpbmcuXG5cbiAgICAgICAgLy8gVWdsaWZ5IGRvZXMgbm90IGhhbmRsZSBFUzYgeWV0LCBzbyB3ZSB3aWxsIGhhdmUgdG8gdHJhbnNwaWxlIHRvIEVTNSBmb3Igbm93LlxuICAgICAgICBjb25zdCBwcmVzZXQgPSAodWdsaWZ5aW5nRW5hYmxlZCAmJiBzZXR0aW5ncy5lbnYgPT09ICdwcm9kJykgP1xuICAgICAgICAgICAgZXMyMDE1UHJlc2V0IDogbm9kZTZQcmVzZXQ7XG5cbiAgICAgICAgZ2xvYi5zeW5jKGAke3RoaXMuJC5lbnYucGF0aHMuZGVza3RvcFRtcC5yb290fS8qKi8qLmpzYCkuZm9yRWFjaCgoZmlsZSkgPT4ge1xuICAgICAgICAgICAgbGV0IHsgY29kZSB9ID0gdHJhbnNmb3JtRmlsZVN5bmMoZmlsZSwge1xuICAgICAgICAgICAgICAgIHByZXNldHM6IFtwcmVzZXRdXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmIChzZXR0aW5ncy5lbnYgPT09ICdwcm9kJyAmJiB1Z2xpZnlpbmdFbmFibGVkKSB7XG4gICAgICAgICAgICAgICAgY29kZSA9IHVnbGlmeS5taW5pZnkoY29kZSwgb3B0aW9ucykuY29kZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZSwgY29kZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE1vdmVzIGFsbCB0aGUgZmlsZXMgdGhhdCBzaG91bGQgbm90IGJlIHBhY2tlZCBpbnRvIGFzYXIgaW50byBhIHNhZmUgbG9jYXRpb24gd2hpY2ggaXMgdGhlXG4gICAgICogJ2V4dHJhY3RlZCcgZGlyIGluIHRoZSBlbGVjdHJvbiBhcHAuXG4gICAgICovXG4gICAgYXN5bmMgZXhjbHVkZUZpbGVzRnJvbUFyY2hpdmUoKSB7XG4gICAgICAgIHRoaXMubG9nLmluZm8oJ2V4Y2x1ZGluZyBmaWxlcyBmcm9tIHBhY2tpbmcnKTtcblxuICAgICAgICAvLyBFbnN1cmUgZW1wdHkgYGV4dHJhY3RlZGAgZGlyXG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuJC51dGlscy5ybVdpdGhSZXRyaWVzKCctcmYnLCB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLmV4dHJhY3RlZCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHNoZWxsLm1rZGlyKHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAuZXh0cmFjdGVkKTtcblxuICAgICAgICBjb25zdCBjb25maWdzID0gdGhpcy4kLmRlc2t0b3AuZ2F0aGVyTW9kdWxlQ29uZmlncygpO1xuXG4gICAgICAgIC8vIE1vdmUgZmlsZXMgdGhhdCBzaG91bGQgbm90IGJlIGFzYXInZWQuXG4gICAgICAgIGNvbmZpZ3MuZm9yRWFjaCgoY29uZmlnKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtb2R1bGVDb25maWcgPSBjb25maWc7XG4gICAgICAgICAgICBpZiAoJ2V4dHJhY3QnIGluIG1vZHVsZUNvbmZpZykge1xuICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShtb2R1bGVDb25maWcuZXh0cmFjdCkpIHtcbiAgICAgICAgICAgICAgICAgICAgbW9kdWxlQ29uZmlnLmV4dHJhY3QgPSBbbW9kdWxlQ29uZmlnLmV4dHJhY3RdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBtb2R1bGVDb25maWcuZXh0cmFjdC5mb3JFYWNoKChmaWxlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKGBleGNsdWRpbmcgJHtmaWxlfSBmcm9tICR7Y29uZmlnLm5hbWV9YCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5qb2luKFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5kZXNrdG9wVG1wLm1vZHVsZXMsIG1vZHVsZUNvbmZpZy5kaXJOYW1lLCBmaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVzdGluYXRpb25QYXRoID0gcGF0aC5qb2luKFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5leHRyYWN0ZWQsIG1vZHVsZUNvbmZpZy5kaXJOYW1lKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuJC51dGlscy5leGlzdHMoZGVzdGluYXRpb25QYXRoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2hlbGwubWtkaXIoZGVzdGluYXRpb25QYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzaGVsbC5tdihmaWxlUGF0aCwgZGVzdGluYXRpb25QYXRoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19