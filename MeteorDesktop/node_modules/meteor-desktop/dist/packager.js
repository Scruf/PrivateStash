'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _assignIn = require('lodash/assignIn');

var _assignIn2 = _interopRequireDefault(_assignIn);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _shelljs = require('shelljs');

var _shelljs2 = _interopRequireDefault(_shelljs);

var _electronPackager = require('electron-packager');

var _electronPackager2 = _interopRequireDefault(_electronPackager);

var _log = require('./log');

var _log2 = _interopRequireDefault(_log);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var join = _path2.default.join;

/**
 * Wrapper around electron-packager.
 * @class
 */

var ElectronPackager = function () {
    function ElectronPackager($) {
        (0, _classCallCheck3.default)(this, ElectronPackager);

        this.log = new _log2.default('electron-packager');
        this.$ = $;
    }

    /**
     * Runs the packager with provided arguments.
     *
     * @param {Object} args
     * @returns {Promise}
     */


    (0, _createClass3.default)(ElectronPackager, [{
        key: 'runPackager',
        value: function runPackager(args) {
            var _this = this;

            return new _promise2.default(function (resolve, reject) {
                (0, _electronPackager2.default)(args, function (err, appPath) {
                    if (err) {
                        reject(err);
                    } else {
                        (function () {
                            _this.log.info('wrote packaged app to ' + _this.$.env.paths.packageDir);

                            var promises = [];
                            appPath.forEach(function (builtAppPath) {
                                var appPathParsed = _path2.default.parse(builtAppPath);
                                promises.push(_this.$.utils.rmWithRetries('-rf', _path2.default.join(_this.$.env.paths.packageDir, appPathParsed.base, 'resources', 'app', 'node_modules')));
                            });
                            _promise2.default.all(promises).then(function () {
                                resolve();
                            }).catch(function (e) {
                                reject(e);
                            });
                        })();
                    }
                });
            });
        }
    }, {
        key: 'packageApp',
        value: function () {
            var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee() {
                var _this2 = this;

                var version, settings, name, arch, args;
                return _regenerator2.default.wrap(function _callee$(_context) {
                    while (1) {
                        switch (_context.prev = _context.next) {
                            case 0:
                                version = JSON.parse(_fs2.default.readFileSync(join(this.$.env.paths.meteorApp.root, 'node_modules', 'electron', 'package.json'), 'UTF-8')).version;
                                settings = this.$.desktop.getSettings();
                                name = settings.name;

                                if (!name) {
                                    this.log.error('`name` field in settings.json not set');
                                    process.exit(1);
                                }

                                arch = this.$.env.options.ia32 ? 'ia32' : 'x64';


                                this.log.info('packaging \'' + name + '\' for platform \'' + this.$.env.sys.platform + '-' + arch + '\'' + (' using electron v' + version));

                                _context.prev = 6;
                                _context.next = 9;
                                return this.$.utils.rmWithRetries('-rf', _path2.default.join(this.$.env.options.output, this.$.env.paths.packageDir));

                            case 9:
                                _context.next = 14;
                                break;

                            case 11:
                                _context.prev = 11;
                                _context.t0 = _context['catch'](6);
                                throw new Error(_context.t0);

                            case 14:
                                args = {
                                    name: name,
                                    version: version,
                                    arch: arch,
                                    platform: this.$.env.sys.platform,
                                    dir: this.$.env.paths.electronApp.root,
                                    out: _path2.default.join(this.$.env.options.output, this.$.env.paths.packageDir)
                                };


                                if ('packagerOptions' in settings) {
                                    (function () {
                                        var packagerOptions = settings.packagerOptions;

                                        ['windows', 'linux', 'osx'].forEach(function (system) {
                                            if (_this2.$.env.os['is' + system[0].toUpperCase() + system.substring(1)] && '_' + system in packagerOptions) {
                                                (0, _assignIn2.default)(packagerOptions, packagerOptions['_' + system]);
                                            }
                                        });

                                        if ('version-string' in packagerOptions) {
                                            (0, _keys2.default)(packagerOptions['version-string']).forEach(function (field) {
                                                if (packagerOptions['version-string'][field] === '@version') {
                                                    packagerOptions['version-string'][field] = settings.version;
                                                }
                                            });
                                        }
                                        (0, _assignIn2.default)(args, packagerOptions);
                                    })();
                                }

                                // Move node_modules away. We do not want to delete it, just temporarily remove it from
                                // our way.
                                _shelljs2.default.mv(this.$.env.paths.electronApp.nodeModules, this.$.env.paths.electronApp.tmpNodeModules);

                                _context.prev = 17;
                                _context.next = 20;
                                return this.runPackager(args);

                            case 20:
                                _context.prev = 20;

                                // Move node_modules back.
                                _shelljs2.default.mv(this.$.env.paths.electronApp.tmpNodeModules, this.$.env.paths.electronApp.nodeModules);
                                return _context.finish(20);

                            case 23:
                            case 'end':
                                return _context.stop();
                        }
                    }
                }, _callee, this, [[6, 11], [17,, 20, 23]]);
            }));

            function packageApp() {
                return _ref.apply(this, arguments);
            }

            return packageApp;
        }()
    }]);
    return ElectronPackager;
}();

exports.default = ElectronPackager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9wYWNrYWdlci5qcyJdLCJuYW1lcyI6WyJqb2luIiwiRWxlY3Ryb25QYWNrYWdlciIsIiQiLCJsb2ciLCJhcmdzIiwicmVzb2x2ZSIsInJlamVjdCIsImVyciIsImFwcFBhdGgiLCJpbmZvIiwiZW52IiwicGF0aHMiLCJwYWNrYWdlRGlyIiwicHJvbWlzZXMiLCJmb3JFYWNoIiwiYnVpbHRBcHBQYXRoIiwiYXBwUGF0aFBhcnNlZCIsInBhcnNlIiwicHVzaCIsInV0aWxzIiwicm1XaXRoUmV0cmllcyIsImJhc2UiLCJhbGwiLCJ0aGVuIiwiY2F0Y2giLCJlIiwidmVyc2lvbiIsIkpTT04iLCJyZWFkRmlsZVN5bmMiLCJtZXRlb3JBcHAiLCJyb290Iiwic2V0dGluZ3MiLCJkZXNrdG9wIiwiZ2V0U2V0dGluZ3MiLCJuYW1lIiwiZXJyb3IiLCJwcm9jZXNzIiwiZXhpdCIsImFyY2giLCJvcHRpb25zIiwiaWEzMiIsInN5cyIsInBsYXRmb3JtIiwib3V0cHV0IiwiRXJyb3IiLCJkaXIiLCJlbGVjdHJvbkFwcCIsIm91dCIsInBhY2thZ2VyT3B0aW9ucyIsInN5c3RlbSIsIm9zIiwidG9VcHBlckNhc2UiLCJzdWJzdHJpbmciLCJmaWVsZCIsIm12Iiwibm9kZU1vZHVsZXMiLCJ0bXBOb2RlTW9kdWxlcyIsInJ1blBhY2thZ2VyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7Ozs7OztJQUVRQSxJLGtCQUFBQSxJOztBQUVSOzs7OztJQUlxQkMsZ0I7QUFFakIsOEJBQVlDLENBQVosRUFBZTtBQUFBOztBQUNYLGFBQUtDLEdBQUwsR0FBVyxrQkFBUSxtQkFBUixDQUFYO0FBQ0EsYUFBS0QsQ0FBTCxHQUFTQSxDQUFUO0FBQ0g7O0FBRUQ7Ozs7Ozs7Ozs7b0NBTVlFLEksRUFBTTtBQUFBOztBQUNkLG1CQUFPLHNCQUFZLFVBQUNDLE9BQUQs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LEtBQUtwRCxDQUFMLENBQU9RLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQm1DLFdBQWpCLENBQTZCVSxjQURqQyxFQUVJLEtBQUt0RCxDQUFMLENBQU9RLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQm1DLFdBQWpCLENBQTZCUyxXQUZqQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O2tCQW5IU3RELGdCIiwiZmlsZSI6InBhY2thZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGFzc2lnbkluIGZyb20gJ2xvZGFzaC9hc3NpZ25Jbic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgc2hlbGwgZnJvbSAnc2hlbGxqcyc7XG5pbXBvcnQgcGFja2FnZXIgZnJvbSAnZWxlY3Ryb24tcGFja2FnZXInO1xuXG5pbXBvcnQgTG9nIGZyb20gJy4vbG9nJztcblxuY29uc3QgeyBqb2luIH0gPSBwYXRoO1xuXG4vKipcbiAqIFdyYXBwZXIgYXJvdW5kIGVsZWN0cm9uLXBhY2thZ2VyLlxuICogQGNsYXNzXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEVsZWN0cm9uUGFja2FnZXIge1xuXG4gICAgY29uc3RydWN0b3IoJCkge1xuICAgICAgICB0aGlzLmxvZyA9IG5ldyBMb2coJ2VsZWN0cm9uLXBhY2thZ2VyJyk7XG4gICAgICAgIHRoaXMuJCA9ICQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUnVucyB0aGUgcGFja2FnZXIgd2l0aCBwcm92aWRlZCBhcmd1bWVudHMuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gYXJnc1xuICAgICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgICAqL1xuICAgIHJ1blBhY2thZ2VyKGFyZ3MpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHBhY2thZ2VyKGFyZ3MsIChlcnIsIGFwcFBhdGgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmluZm8oYHdyb3RlIHBhY2thZ2VkIGFwcCB0byAke3RoaXMuJC5lbnYucGF0aHMucGFja2FnZURpcn1gKTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBhcHBQYXRoLmZvckVhY2goKGJ1aWx0QXBwUGF0aCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXBwUGF0aFBhcnNlZCA9IHBhdGgucGFyc2UoYnVpbHRBcHBQYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2VzLnB1c2godGhpcy4kLnV0aWxzLnJtV2l0aFJldHJpZXMoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJy1yZicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aC5qb2luKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLnBhY2thZ2VEaXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcFBhdGhQYXJzZWQuYmFzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Jlc291cmNlcycsICdhcHAnLCAnbm9kZV9tb2R1bGVzJylcbiAgICAgICAgICAgICAgICAgICAgICAgICkpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcGFja2FnZUFwcCgpIHtcbiAgICAgICAgY29uc3QgdmVyc2lvbiA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKFxuICAgICAgICAgICAgam9pbihcbiAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLm1ldGVvckFwcC5yb290LFxuICAgICAgICAgICAgICAgICdub2RlX21vZHVsZXMnLFxuICAgICAgICAgICAgICAgICdlbGVjdHJvbicsXG4gICAgICAgICAgICAgICAgJ3BhY2thZ2UuanNvbidcbiAgICAgICAgICAgICksICdVVEYtOCcpXG4gICAgICAgICkudmVyc2lvbjtcblxuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHRoaXMuJC5kZXNrdG9wLmdldFNldHRpbmdzKCk7XG4gICAgICAgIGNvbnN0IG5hbWUgPSBzZXR0aW5ncy5uYW1lO1xuICAgICAgICBpZiAoIW5hbWUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdgbmFtZWAgZmllbGQgaW4gc2V0dGluZ3MuanNvbiBub3Qgc2V0Jyk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBhcmNoID0gdGhpcy4kLmVudi5vcHRpb25zLmlhMzIgPyAnaWEzMicgOiAneDY0JztcblxuICAgICAgICB0aGlzLmxvZy5pbmZvKFxuICAgICAgICAgICAgYHBhY2thZ2luZyAnJHtuYW1lfScgZm9yIHBsYXRmb3JtICcke3RoaXMuJC5lbnYuc3lzLnBsYXRmb3JtfS0ke2FyY2h9J2AgK1xuICAgICAgICAgICAgYCB1c2luZyBlbGVjdHJvbiB2JHt2ZXJzaW9ufWBcbiAgICAgICAgKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy4kLnV0aWxzLnJtV2l0aFJldHJpZXMoXG4gICAgICAgICAgICAgICAgJy1yZicsIHBhdGguam9pbih0aGlzLiQuZW52Lm9wdGlvbnMub3V0cHV0LCB0aGlzLiQuZW52LnBhdGhzLnBhY2thZ2VEaXIpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYXJncyA9IHtcbiAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICB2ZXJzaW9uLFxuICAgICAgICAgICAgYXJjaCxcbiAgICAgICAgICAgIHBsYXRmb3JtOiB0aGlzLiQuZW52LnN5cy5wbGF0Zm9ybSxcbiAgICAgICAgICAgIGRpcjogdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5yb290LFxuICAgICAgICAgICAgb3V0OiBwYXRoLmpvaW4odGhpcy4kLmVudi5vcHRpb25zLm91dHB1dCwgdGhpcy4kLmVudi5wYXRocy5wYWNrYWdlRGlyKVxuICAgICAgICB9O1xuXG4gICAgICAgIGlmICgncGFja2FnZXJPcHRpb25zJyBpbiBzZXR0aW5ncykge1xuICAgICAgICAgICAgY29uc3QgcGFja2FnZXJPcHRpb25zID0gc2V0dGluZ3MucGFja2FnZXJPcHRpb25zO1xuXG4gICAgICAgICAgICBbJ3dpbmRvd3MnLCAnbGludXgnLCAnb3N4J10uZm9yRWFjaCgoc3lzdGVtKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICB0aGlzLiQuZW52Lm9zW2BpcyR7c3lzdGVtWzBdLnRvVXBwZXJDYXNlKCl9JHtzeXN0ZW0uc3Vic3RyaW5nKDEpfWBdICYmXG4gICAgICAgICAgICAgICAgICAgIChgXyR7c3lzdGVtfWApIGluIHBhY2thZ2VyT3B0aW9uc1xuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICBhc3NpZ25JbihwYWNrYWdlck9wdGlvbnMsIHBhY2thZ2VyT3B0aW9uc1tgXyR7c3lzdGVtfWBdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKCd2ZXJzaW9uLXN0cmluZycgaW4gcGFja2FnZXJPcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXMocGFja2FnZXJPcHRpb25zWyd2ZXJzaW9uLXN0cmluZyddKS5mb3JFYWNoKChmaWVsZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAocGFja2FnZXJPcHRpb25zWyd2ZXJzaW9uLXN0cmluZyddW2ZpZWxkXSA9PT0gJ0B2ZXJzaW9uJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFja2FnZXJPcHRpb25zWyd2ZXJzaW9uLXN0cmluZyddW2ZpZWxkXSA9IHNldHRpbmdzLnZlcnNpb247XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFzc2lnbkluKGFyZ3MsIHBhY2thZ2VyT3B0aW9ucyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBNb3ZlIG5vZGVfbW9kdWxlcyBhd2F5LiBXZSBkbyBub3Qgd2FudCB0byBkZWxldGUgaXQsIGp1c3QgdGVtcG9yYXJpbHkgcmVtb3ZlIGl0IGZyb21cbiAgICAgICAgLy8gb3VyIHdheS5cbiAgICAgICAgc2hlbGwubXYoXG4gICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLm5vZGVNb2R1bGVzLFxuICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC50bXBOb2RlTW9kdWxlc1xuICAgICAgICApO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnJ1blBhY2thZ2VyKGFyZ3MpO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgLy8gTW92ZSBub2RlX21vZHVsZXMgYmFjay5cbiAgICAgICAgICAgIHNoZWxsLm12KFxuICAgICAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAudG1wTm9kZU1vZHVsZXMsXG4gICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5ub2RlTW9kdWxlc1xuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==